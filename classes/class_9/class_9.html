
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Class 9: Advanced and Performant Python &#8212; Python for Neuroscience</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet">
  <link href="../../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx_tabs/semantic-ui-2.4.1/segment.min.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx_tabs/semantic-ui-2.4.1/menu.min.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx_tabs/semantic-ui-2.4.1/tab.min.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx_tabs/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script >let toggleHintShow = 'Click to show';</script>
    <script >let toggleHintHide = 'Click to hide';</script>
    <script >let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script >const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Class 10: Introduction to Machine Learning" href="../class_10/class_10.html" />
    <link rel="prev" title="Class 8: Testing and Test-Driven Development" href="../class_8/class_8.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Python for Neuroscience</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../intro.html">
   Introduction
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../syllabus.html">
   Syllabus
  </a>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="../../contents.html">
   Contents
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="../class_0/class_0.html">
     Class 0: Background and Basic Syntax
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../class_1/class_1.html">
     Class 1: More Syntax and The Python Stack
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../class_2/class_2.html">
     Class 2: Virtual Environments and Object-oriented Programming (OOP)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../class_3/class_3.html">
     Class 3: More OOP and Exception Handling
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../class_4/class_4.html">
     Class 4: The Scientific Stack - Part I:
     <code class="docutils literal notranslate">
      <span class="pre">
       numpy
      </span>
     </code>
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../class_5/class_5.html">
     Class 5: The Scientific Stack - Part II:
     <code class="docutils literal notranslate">
      <span class="pre">
       matplotlib
      </span>
     </code>
     and
     <code class="docutils literal notranslate">
      <span class="pre">
       pandas
      </span>
     </code>
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../class_6/class_6.html">
     Class 6: Advanced
     <code class="docutils literal notranslate">
      <span class="pre">
       pandas
      </span>
     </code>
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../class_7/class_7.html">
     Class 7: More
     <code class="docutils literal notranslate">
      <span class="pre">
       pandas
      </span>
     </code>
     , Visualizations,
     <code class="docutils literal notranslate">
      <span class="pre">
       xarray
      </span>
     </code>
     and Modeling
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../class_8/class_8.html">
     Class 8: Testing and Test-Driven Development
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Class 9: Advanced and Performant Python
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../class_10/class_10.html">
     Class 10: Introduction to Machine Learning
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../class_11/class_11.html">
     Class 11: Git and More Python Libraries
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../tutorials.html">
   Tutorials
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../tutorials/python_setup.html">
     General Setup
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../tutorials/create_git_repo.html">
     Create a Git Repository
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../tutorials/create_and_publish_pacakge.html">
     Creating and Publishing a Python Library
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../resources.html">
   Resources
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../_sources/classes/class_9/class_9.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        
        <a class="issues-button"
            href="https://github.com/sagol-python-for-neuroscientists/textbook-public/issues/new?title=Issue%20on%20page%20%2Fclasses/class_9/class_9.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/sagol-python-for-neuroscientists/textbook-public/main?urlpath=tree/source/classes/class_9/class_9.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#generators">
   Generators
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#generator-creation-and-iteration">
     Generator Creation and Iteration
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#generator-expressions">
       Generator Expressions
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#use-cases">
     Use cases
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#args-kwargs">
   <code class="docutils literal notranslate">
    <span class="pre">
     *args
    </span>
   </code>
   ,
   <code class="docutils literal notranslate">
    <span class="pre">
     **kwargs
    </span>
   </code>
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#decorators">
   Decorators
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#more-useful-built-in-modules">
   More Useful Built-in Modules
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#collections">
     <code class="docutils literal notranslate">
      <span class="pre">
       collections
      </span>
     </code>
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#namedtuple">
       <code class="docutils literal notranslate">
        <span class="pre">
         namedtuple
        </span>
       </code>
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#defaultdict">
       <code class="docutils literal notranslate">
        <span class="pre">
         defaultdict
        </span>
       </code>
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#itertools">
     <code class="docutils literal notranslate">
      <span class="pre">
       Itertools
      </span>
     </code>
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#chained-iterables">
       Chained iterables
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#permutations">
       Permutations
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#combinations">
       Combinations
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#multiprocessing">
   Multiprocessing
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#numba">
   Numba
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#cython">
   Cython
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#memoization-caching">
   Memoization (Caching)
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#code-smells">
   “Code Smells”
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#repetitive-code">
     Repetitive code
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#long-functions-with-block-comments">
     Long functions (with “block comments”)
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#objects-that-should-be-functions-functions-that-should-be-objects">
     Objects that should be functions, functions that should be objects
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#long-list-of-arguments">
       Long list of arguments
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#objects-with-either-one-or-two-methods">
       Objects with either one or two methods
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#hard-to-explain">
       Hard to explain
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#too-many-nested-levels">
     Too many nested levels
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#early-returns">
       Early returns
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#switch-like-statement-in-python">
       Switch-like statement in Python
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#software-design-principles">
   Software Design Principles
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#object-orthogonality-and-encapsulation">
     Object Orthogonality and Encapsulation
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#data">
       <code class="docutils literal notranslate">
        <span class="pre">
         Data
        </span>
       </code>
       :
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#datacontainer">
       <code class="docutils literal notranslate">
        <span class="pre">
         DataContainer
        </span>
       </code>
       :
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#classes-as-data-types-and-class-methods">
     Classes as Data Types and Class Methods
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#typestates">
     Typestates
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#helper-concepts-and-libraries">
   Helper Concepts and Libraries
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-formatting-styling-and-linting">
     Code formatting, styling and linting
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#type-annotations-and-mypy">
     Type Annotations and MyPy
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#linters-pylint-flake8">
     Linters (
     <code class="docutils literal notranslate">
      <span class="pre">
       pylint
      </span>
     </code>
     ,
     <code class="docutils literal notranslate">
      <span class="pre">
       flake8
      </span>
     </code>
     )
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#enumerations">
     Enumerations
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#attrs-classes-without-boilerplate">
     <code class="docutils literal notranslate">
      <span class="pre">
       attrs
      </span>
     </code>
     - Classes without boilerplate
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#dimensionality-analysis-and-units">
     Dimensionality analysis and units
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#design-vs-productivity">
   Design vs. Productivity
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Class 9: Advanced and Performant Python</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#generators">
   Generators
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#generator-creation-and-iteration">
     Generator Creation and Iteration
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#generator-expressions">
       Generator Expressions
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#use-cases">
     Use cases
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#args-kwargs">
   <code class="docutils literal notranslate">
    <span class="pre">
     *args
    </span>
   </code>
   ,
   <code class="docutils literal notranslate">
    <span class="pre">
     **kwargs
    </span>
   </code>
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#decorators">
   Decorators
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#more-useful-built-in-modules">
   More Useful Built-in Modules
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#collections">
     <code class="docutils literal notranslate">
      <span class="pre">
       collections
      </span>
     </code>
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#namedtuple">
       <code class="docutils literal notranslate">
        <span class="pre">
         namedtuple
        </span>
       </code>
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#defaultdict">
       <code class="docutils literal notranslate">
        <span class="pre">
         defaultdict
        </span>
       </code>
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#itertools">
     <code class="docutils literal notranslate">
      <span class="pre">
       Itertools
      </span>
     </code>
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#chained-iterables">
       Chained iterables
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#permutations">
       Permutations
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#combinations">
       Combinations
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#multiprocessing">
   Multiprocessing
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#numba">
   Numba
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#cython">
   Cython
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#memoization-caching">
   Memoization (Caching)
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#code-smells">
   “Code Smells”
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#repetitive-code">
     Repetitive code
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#long-functions-with-block-comments">
     Long functions (with “block comments”)
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#objects-that-should-be-functions-functions-that-should-be-objects">
     Objects that should be functions, functions that should be objects
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#long-list-of-arguments">
       Long list of arguments
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#objects-with-either-one-or-two-methods">
       Objects with either one or two methods
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#hard-to-explain">
       Hard to explain
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#too-many-nested-levels">
     Too many nested levels
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#early-returns">
       Early returns
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#switch-like-statement-in-python">
       Switch-like statement in Python
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#software-design-principles">
   Software Design Principles
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#object-orthogonality-and-encapsulation">
     Object Orthogonality and Encapsulation
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#data">
       <code class="docutils literal notranslate">
        <span class="pre">
         Data
        </span>
       </code>
       :
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#datacontainer">
       <code class="docutils literal notranslate">
        <span class="pre">
         DataContainer
        </span>
       </code>
       :
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#classes-as-data-types-and-class-methods">
     Classes as Data Types and Class Methods
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#typestates">
     Typestates
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#helper-concepts-and-libraries">
   Helper Concepts and Libraries
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-formatting-styling-and-linting">
     Code formatting, styling and linting
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#type-annotations-and-mypy">
     Type Annotations and MyPy
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#linters-pylint-flake8">
     Linters (
     <code class="docutils literal notranslate">
      <span class="pre">
       pylint
      </span>
     </code>
     ,
     <code class="docutils literal notranslate">
      <span class="pre">
       flake8
      </span>
     </code>
     )
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#enumerations">
     Enumerations
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#attrs-classes-without-boilerplate">
     <code class="docutils literal notranslate">
      <span class="pre">
       attrs
      </span>
     </code>
     - Classes without boilerplate
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#dimensionality-analysis-and-units">
     Dimensionality analysis and units
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#design-vs-productivity">
   Design vs. Productivity
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="class-9-advanced-and-performant-python">
<h1>Class 9: Advanced and Performant Python<a class="headerlink" href="#class-9-advanced-and-performant-python" title="Permalink to this headline">¶</a></h1>
<p>One of the best things about Python is how easy it is to get started with. The syntax is clear, it has all the basic features, things work in a relatively intuitive way, life is good. But Python also supports very advanced features, which make coding with Python an enjoyable experience even after you think you’ve learned everything there is to know of the language. You can always dive a little deeper. You’re not required to, but you can.</p>
<div class="section" id="generators">
<h2>Generators<a class="headerlink" href="#generators" title="Permalink to this headline">¶</a></h2>
<p>In simplistic terms, generators are iterators. Meaning, a generator is always an object you can iterate over. In Python you can iterate over most data structures, including dictionaries, lists, tuples and more - and so in this sense generators are similar. However, when we iterate over a list, for example, we’re iterating over an existing data structures with existing items. Same goes for dictionaries, when we iterate over them, Python “hands over” the dictionary’s keys and values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span>
<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">a_list</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0
10
20
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">a_dict</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">a_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>a 0
b 10
c 20
</pre></div>
</div>
</div>
</div>
<p>This is the first major difference between a generator and the other iterators. A generator is a <em>recipe</em> to create the next item in the chain. A generator is a piece of code telling the Python interpreter how to create the next item, but it doesn’t hold this item in memory yet. A simple example might be a list containing values from 0 to 1000. A generator of this list will not have 1000 cells with their values - it would have instructions on the number of cells, and how to calculate the next value.</p>
<p>We’ve already met a kind of generator: the <code class="docutils literal notranslate"><span class="pre">range()</span></code> function. When we tell Python to give us a range of number between 0 and 1000 by writing <code class="docutils literal notranslate"><span class="pre">range(1000)</span></code> - we’re not actually generating the 1000 “cells” of values, but only the recipe. Let’s see it in “action”:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>  <span class="c1"># a &quot;range&quot; object</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>range(0, 1000)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">items</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">items</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>range(0, 1000)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">getsizeof</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>48
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sys</span><span class="o">.</span><span class="n">getsizeof</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">items</span><span class="p">))</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>8056
</pre></div>
</div>
</div>
</div>
<p>A simple 1000-element list isn’t that heavy for a computer (even an Arduino or similar), but when lists get longer, with bigger arrays and massive data structures inside them, it’s very inefficient to hold this amount of unused data in memory.</p>
<div class="section" id="generator-creation-and-iteration">
<h3>Generator Creation and Iteration<a class="headerlink" href="#generator-creation-and-iteration" title="Permalink to this headline">¶</a></h3>
<p>Let’s define our own generator:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">my_range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a list of items from 0 to n.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n : int</span>
<span class="sd">        Number of items to generate</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">num</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">num</span>
        <span class="n">num</span> <span class="o">+=</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<p>When we create a generator, the code is executed until the first <code class="docutils literal notranslate"><span class="pre">yield</span></code> statement. This reserved keyword is what makes a function into a generator.</p>
<p>When the code reaches the <code class="docutils literal notranslate"><span class="pre">yield</span></code> it holds, or “saves” its current state, until called by Python’s <code class="docutils literal notranslate"><span class="pre">next()</span></code> function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">new_range</span> <span class="o">=</span> <span class="n">my_range</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">new_range</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">new_range</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">new_range</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">new_range</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0
1
2
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">StopIteration</span><span class="g g-Whitespace">                             </span>Traceback (most recent call last)
<span class="nn">Input In [8],</span> in <span class="ni">&lt;cell line: 9&gt;</span><span class="nt">()</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="nb">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">new_range</span><span class="p">))</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span> <span class="nb">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">new_range</span><span class="p">))</span>
<span class="ne">----&gt; </span><span class="mi">9</span> <span class="nb">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">new_range</span><span class="p">))</span>

<span class="ne">StopIteration</span>: 
</pre></div>
</div>
</div>
</div>
<p>Each time <code class="docutils literal notranslate"><span class="pre">next()</span></code> is used, the line with the <code class="docutils literal notranslate"><span class="pre">yield</span></code> is executed, and the function keeps going until it reaches  another <code class="docutils literal notranslate"><span class="pre">yield</span></code> statement. In the <code class="docutils literal notranslate"><span class="pre">my_range</span></code> function, while the index is smaller than <code class="docutils literal notranslate"><span class="pre">n</span></code> the code will reach a <code class="docutils literal notranslate"><span class="pre">yield</span></code>. When we don’t satisfy this condition anymore, the code skips the loop and reaches the end of the function. This results in a special <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code> exception, used only in these special cases. This means you can catch this exception and know that your generator went through all of its items.</p>
<p>But calling <code class="docutils literal notranslate"><span class="pre">next()</span></code> multiple times isn’t practical. Luckily, <code class="docutils literal notranslate"><span class="pre">for</span></code> loops implement this exact interface automatically, allowing us to use them instead of the tedious, repetitive <code class="docutils literal notranslate"><span class="pre">next()</span></code> calls:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">loop_range</span> <span class="o">=</span> <span class="n">my_range</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">loop_range</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0
1
2
3
4
5
6
7
8
9
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">for</span></code> loop is also smart enough to catch the <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code> exception and terminate the loop, without raising any “visible” exceptions. A <code class="docutils literal notranslate"><span class="pre">for</span></code> loop is the common way to iterate over generators.</p>
<p>Note that “holding off” the generation of the values means we can’t access the complete data structure. If we try to print it, we will simply get the generator instance’s representation string:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">range2</span> <span class="o">=</span> <span class="n">my_range</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">range2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;generator object my_range at 0x7f7664130cf0&gt;
</pre></div>
</div>
</div>
</div>
<p>The same applies for indexing:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">range2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="nn">Input In [11],</span> in <span class="ni">&lt;cell line: 1&gt;</span><span class="nt">()</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">range2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

<span class="ne">TypeError</span>: &#39;generator&#39; object is not subscriptable
</pre></div>
</div>
</div>
</div>
<p>Once used, generators are “depleted”, you can’t reuse them. This is a major difference between a generator and a list. For example, you’re not limited by the number of times you can iterate over a list.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">loop_range</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Using a <code class="docutils literal notranslate"><span class="pre">for</span></code> loop doesn’t return anything, because we already depleted <code class="docutils literal notranslate"><span class="pre">loop_range</span></code>.</p>
<p>Let’s try something more explicit:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">next</span><span class="p">(</span><span class="n">loop_range</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">StopIteration</span><span class="g g-Whitespace">                             </span>Traceback (most recent call last)
<span class="nn">Input In [13],</span> in <span class="ni">&lt;cell line: 1&gt;</span><span class="nt">()</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="nb">next</span><span class="p">(</span><span class="n">loop_range</span><span class="p">)</span>

<span class="ne">StopIteration</span>: 
</pre></div>
</div>
</div>
</div>
<p>It’s important to stress that all functions can become generators if they contain the <code class="docutils literal notranslate"><span class="pre">yield</span></code> statement:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">print_stuff</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Hello, &quot;</span><span class="p">)</span>
    <span class="k">yield</span> <span class="kc">True</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;World&quot;</span><span class="p">)</span>
    <span class="k">yield</span> <span class="kc">False</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stuff_printer</span> <span class="o">=</span> <span class="n">print_stuff</span><span class="p">()</span>
<span class="n">stuff</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">stuff_printer</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">stuff</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Hello, 
True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">more_stuff</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">stuff_printer</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">more_stuff</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>World
False
</pre></div>
</div>
</div>
</div>
<div class="section" id="generator-expressions">
<h4>Generator Expressions<a class="headerlink" href="#generator-expressions" title="Permalink to this headline">¶</a></h4>
<p>Another way to create generators is “genexps”, or generator expressions, which are very similar to list comprehensions:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nums</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="n">nums</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;generator object &lt;genexpr&gt; at 0x7f76641305f0&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">nums</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0
2
4
6
8
10
12
14
16
18
</pre></div>
</div>
</div>
</div>
<p>The round brackets (<code class="docutils literal notranslate"><span class="pre">()</span></code>) tell the interpreter that we’re creating a generator.</p>
</div>
</div>
<div class="section" id="use-cases">
<h3>Use cases<a class="headerlink" href="#use-cases" title="Permalink to this headline">¶</a></h3>
<p>When should we use generators? Many libraries use them almost ubiquitously. For example, <code class="docutils literal notranslate"><span class="pre">pathlib</span></code> uses them to iterate over the content of directories - it’s not “cheap” to get the full directory’s content and then iterate over it, so <code class="docutils literal notranslate"><span class="pre">pathlib</span></code> uses a generator to yield the next item every time.</p>
<p>In our field of work, generators can either be great to have in order to improve the performance of your code, or an absolute necessity if you’re working with very large data structures that simply cannot be handled in-memory. In any case, implementing and using generators is easy and incredibly beneficial for various computations.</p>
<div class="admonition-exercise-fibonacci-generator admonition">
<p class="admonition-title">Exercise: Fibonacci Generator</p>
<p>Write a generator function returning the first <code class="docutils literal notranslate"><span class="pre">n</span></code> Fibonacci numbers.</p>
<details class="sphinx-bs dropdown card mb-3">
<summary class="summary-title card-header">
Solution<div class="summary-down docutils">
<svg version="1.1" width="24" height="24" class="octicon octicon-chevron-down" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.22 8.72a.75.75 0 000 1.06l6.25 6.25a.75.75 0 001.06 0l6.25-6.25a.75.75 0 00-1.06-1.06L12 14.44 6.28 8.72a.75.75 0 00-1.06 0z"></path></svg></div>
<div class="summary-up docutils">
<svg version="1.1" width="24" height="24" class="octicon octicon-chevron-up" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M18.78 15.28a.75.75 0 000-1.06l-6.25-6.25a.75.75 0 00-1.06 0l-6.25 6.25a.75.75 0 101.06 1.06L12 9.56l5.72 5.72a.75.75 0 001.06 0z"></path></svg></div>
</summary><div class="summary-content card-body docutils">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">generate_n_fibonacci</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates the first n Fibonacci numbers.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n : int</span>
<span class="sd">        Length of the generated Fibonacci sequence</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">index</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">a</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
        <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</details><p><em>Bonus: Modify your solution to create an infinite Fibonacci generator (infinite in the sense that as long as iteration over it is continued, the next number will be generated).</em></p>
<details class="sphinx-bs dropdown card mb-3">
<summary class="summary-title card-header">
Solution<div class="summary-down docutils">
<svg version="1.1" width="24" height="24" class="octicon octicon-chevron-down" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.22 8.72a.75.75 0 000 1.06l6.25 6.25a.75.75 0 001.06 0l6.25-6.25a.75.75 0 00-1.06-1.06L12 14.44 6.28 8.72a.75.75 0 00-1.06 0z"></path></svg></div>
<div class="summary-up docutils">
<svg version="1.1" width="24" height="24" class="octicon octicon-chevron-up" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M18.78 15.28a.75.75 0 000-1.06l-6.25-6.25a.75.75 0 00-1.06 0l-6.25 6.25a.75.75 0 101.06 1.06L12 9.56l5.72 5.72a.75.75 0 001.06 0z"></path></svg></div>
</summary><div class="summary-content card-body docutils">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">generate_fibonacci</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fibonacci sequence generator.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">a</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
</pre></div>
</div>
</div>
</details></div>
</div>
</div>
<div class="section" id="args-kwargs">
<h2><code class="docutils literal notranslate"><span class="pre">*args</span></code>, <code class="docutils literal notranslate"><span class="pre">**kwargs</span></code><a class="headerlink" href="#args-kwargs" title="Permalink to this headline">¶</a></h2>
<p>You use <code class="docutils literal notranslate"><span class="pre">*args</span></code> and <code class="docutils literal notranslate"><span class="pre">**kwargs</span></code> when you would like to enable a flexible number of arguments that may be passed to a function. Actually, the syntax is only <code class="docutils literal notranslate"><span class="pre">*</span></code> and <code class="docutils literal notranslate"><span class="pre">**</span></code> - the words <code class="docutils literal notranslate"><span class="pre">args</span></code> and <code class="docutils literal notranslate"><span class="pre">kwargs</span></code> are simply used by convention. <code class="docutils literal notranslate"><span class="pre">args</span></code> is obviously arguments, or unnamed arguments given to a function, and <code class="docutils literal notranslate"><span class="pre">kwargs</span></code> is keyword arguments, or arguments given as <code class="docutils literal notranslate"><span class="pre">key=value</span></code> pairs. Let’s see a simple example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">required_argument</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">required_argument</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;I found something in args!&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;I found something in kwargs!&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="p">()</span>  <span class="c1"># doesn&#39;t work - we have one required argument to the function</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="nn">Input In [20],</span> in <span class="ni">&lt;cell line: 1&gt;</span><span class="nt">()</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">f</span><span class="p">()</span>

<span class="ne">TypeError</span>: f() missing 1 required positional argument: &#39;required_argument&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="p">(</span><span class="s1">&#39;required&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>required
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="p">(</span><span class="s1">&#39;required&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># the second printed row is the args</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>required
I found something in args!
(1, 2, 3)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="p">(</span><span class="s1">&#39;required&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">kw1</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">kw2</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>required
I found something in args!
(1, 2, 3)
I found something in kwargs!
kw1 a
kw2 b
</pre></div>
</div>
</div>
</div>
<p>We see that <code class="docutils literal notranslate"><span class="pre">args</span></code> is a tuple containing all unnamed parameters that were given to the function in the order they were given, and <code class="docutils literal notranslate"><span class="pre">kwargs</span></code> is a dictionary.</p>
<p>Essentially, using <code class="docutils literal notranslate"><span class="pre">*</span></code> in the function’s signature is the inverse of using it for expansion when calling the function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

<span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">}</span>
<span class="n">f</span><span class="p">(</span><span class="o">**</span><span class="n">inputs</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">f2</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

<span class="n">my_inputs</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">f2</span><span class="p">(</span><span class="o">*</span><span class="n">my_inputs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>10 20
1 2
</pre></div>
</div>
</div>
</div>
<p>What we see here is that the function’s signature doesn’t have to contain <code class="docutils literal notranslate"><span class="pre">*args</span></code> or <code class="docutils literal notranslate"><span class="pre">**kwargs</span></code>. The <code class="docutils literal notranslate"><span class="pre">**</span></code> operator “opens up” the input dictionary, allowing the <code class="docutils literal notranslate"><span class="pre">f()</span></code> function to use the parameters without any issues.</p>
</div>
<div class="section" id="decorators">
<h2>Decorators<a class="headerlink" href="#decorators" title="Permalink to this headline">¶</a></h2>
<p>Decorators are functions that receive functions in their arguments. When you wrap an existing function with another function, you’re creating a decorator. This feature is extensively used in web frameworks, pytest and in other important Python use cases, which means it has a special syntax: <code class="docutils literal notranslate"><span class="pre">&#64;decorator</span></code>. Let’s look at an example:</p>
<p>Assume I have a large data-processing pipeline script, built out of many smaller functions, which unfortunately takes a long time to run. I wish to understand <em>why</em> it’s taking so long, so I decide to add a printed statement at the start and end of each function, so that I could see with my eyes where the code “hangs”. This is how I implemented it:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">main_pipeline</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    <span class="n">processed</span> <span class="o">=</span> <span class="n">process_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">appended</span> <span class="o">=</span> <span class="n">append_data</span><span class="p">(</span><span class="n">processed</span><span class="p">)</span>
    <span class="n">logged</span> <span class="o">=</span> <span class="n">log_data</span><span class="p">(</span><span class="n">appended</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting &#39;load_data&#39;...&quot;</span><span class="p">)</span>
    <span class="c1"># ... Code ...</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ending &#39;load_data&#39;...&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">process_data</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting &#39;process_data&#39;...&quot;</span><span class="p">)</span>
    <span class="c1"># ... Code ...</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ending &#39;process_data&#39;...&quot;</span><span class="p">)</span>
    
<span class="c1"># And so on...</span>
</pre></div>
</div>
</div>
</div>
<p>This is obviously very tedious. Even when I only have four functions, it’s very repetitive and feels wrong. Moreover, it might have not solved my issue. Let’s say my manual examination showed that all four functions take a considerable time to run, so I decide to profile the execution time of each function, to better understand which function is the most costly and optimize it first.</p>
<p>Here’s how I redefined all functions to measure their execution time:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>


<span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting &#39;load_data&#39; at </span><span class="si">{</span><span class="n">start_time</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>    
    <span class="c1"># ... Code ...</span>
    <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ended &#39;load_data&#39; at </span><span class="si">{</span><span class="n">end_time</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
    <span class="n">duration</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;It took the code </span><span class="si">{</span><span class="n">duration</span><span class="si">}</span><span class="s2"> milliseconds to run.&quot;</span><span class="p">)</span>    

    
<span class="k">def</span> <span class="nf">process_data</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting &#39;process_data&#39; at </span><span class="si">{</span><span class="n">start_time</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>    
    <span class="c1"># ... Code ...</span>
    <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ended &#39;process_data&#39; at </span><span class="si">{</span><span class="n">end_time</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
    <span class="n">duration</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;It took the code </span><span class="si">{</span><span class="n">duration</span><span class="si">}</span><span class="s2"> milliseconds to run.&quot;</span><span class="p">)</span>    
    
<span class="c1"># And so on...</span>
</pre></div>
</div>
</div>
</div>
<p>This works, but again, it’s very repetitive. Also, if I decide that I want to see the execution time in seconds, and not milliseconds, I have to go through each function and re-implement it. Very tedious.</p>
<p>Consider the following solution instead:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">printer</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">inner_func</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting </span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ending </span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">return</span> <span class="n">inner_func</span>      


<span class="k">def</span> <span class="nf">timer</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">inner_func</span><span class="p">(</span><span class="n">argument</span><span class="p">):</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">argument</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;It tooks the code </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="si">}</span><span class="s2"> milliseconds to run.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">return</span> <span class="n">inner_func</span>
</pre></div>
</div>
</div>
</div>
<p>This looks complex at first, but it’s really pretty simple. It uses the fact that functions in Python are objects, like any other element in the language. And because they’re objects, they can be passed around as arguments:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Runs the func functions and prints &#39;hi&#39; at the end &quot;&quot;&quot;</span>
    <span class="n">func</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;hi&quot;</span><span class="p">)</span>
    
<span class="k">def</span> <span class="nf">print_hello</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">)</span>
    

<span class="n">f</span><span class="p">(</span><span class="n">print_hello</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>hello
hi
</pre></div>
</div>
</div>
</div>
<p>Like all objects, functions have attributes. Namely, they have the <code class="docutils literal notranslate"><span class="pre">__name__</span></code> attribute which contains… their name.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">print_hello</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>f
print_hello
</pre></div>
</div>
</div>
</div>
<p>Now we know we can pass functions as arguments to other functions. Let’s try to examine the <code class="docutils literal notranslate"><span class="pre">printer</span></code> and <code class="docutils literal notranslate"><span class="pre">timer</span></code> functions again.</p>
<p>They’re both a function that receives a different, “unknown” function, as its argument. So far, so good. Then it defines another function which “wraps” the original function with some actions, like printing or timing. This inner function runs the original function and returns the result. In essence, it created a “new implementation” of that original function that does the exact same thing, but with the wrapping functionality (printing, timing, etc.). This new function (<code class="docutils literal notranslate"><span class="pre">inner_func</span></code>) can replace any instance of the original function without any troubles, since in essence it just calls it. It’s adds a couple of statements before and after that call, but the essential functionality remained unchanged.</p>
<p>Lastly, the outer function, which we call the decorator, returns the inner function as its return value. So this function receives a function as its argument and return a new, improved function as its output. To use it, we just “rename” the existing functions:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">load_data_printer</span> <span class="o">=</span> <span class="n">printer</span><span class="p">(</span><span class="n">load_data</span><span class="p">)</span>
<span class="n">load_data_timed</span> <span class="o">=</span> <span class="n">timer</span><span class="p">(</span><span class="n">load_data</span><span class="p">)</span>

<span class="n">process_data_printer</span> <span class="o">=</span> <span class="n">printer</span><span class="p">(</span><span class="n">process_data</span><span class="p">)</span>
<span class="n">process_data_timed</span> <span class="o">=</span> <span class="n">timer</span><span class="p">(</span><span class="n">process_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can obviously use this <code class="docutils literal notranslate"><span class="pre">timer</span></code> function on any function we wish to time. When we wish to time functions in seconds, rather than milliseconds, we’ll just change this one instance of <code class="docutils literal notranslate"><span class="pre">timer</span></code> and be done with it, and likewise for <code class="docutils literal notranslate"><span class="pre">printer</span></code>.</p>
<p>The only small caveat here is the fact that we currently require the function we’re replacing to have a single <code class="docutils literal notranslate"><span class="pre">argument</span></code> as its argument. This implementation detail is small but very impactful - it means that our decorator will only decorate successfully functions that have a single argument. To remedy this we’ll have to use <code class="docutils literal notranslate"><span class="pre">*args</span></code> and <code class="docutils literal notranslate"><span class="pre">**kwargs</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">printer</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">inner_func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting </span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ending </span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">return</span> <span class="n">inner_func</span>      


<span class="k">def</span> <span class="nf">timer</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">inner_func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;It tooks the code </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="si">}</span><span class="s2"> milliseconds to run.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">return</span> <span class="n">inner_func</span>
</pre></div>
</div>
</div>
</div>
<p>We can now be sure that our functions will always run regardless the number of inputs given to them. However, we still have to redefine all functions as we’ve seen before:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">load_data_printer</span> <span class="o">=</span> <span class="n">printer</span><span class="p">(</span><span class="n">load_data</span><span class="p">)</span>
<span class="n">load_data_timed</span> <span class="o">=</span> <span class="n">timer</span><span class="p">(</span><span class="n">load_data</span><span class="p">)</span>

<span class="n">process_data_printer</span> <span class="o">=</span> <span class="n">printer</span><span class="p">(</span><span class="n">process_data</span><span class="p">)</span>
<span class="n">process_data_timed</span> <span class="o">=</span> <span class="n">timer</span><span class="p">(</span><span class="n">process_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>This still requires us to rename all instances of these functions in all places of the code, and when we’re done with the printing and timing, we have to rename them back.</p>
<p>Why not “rename” the function back to its original name?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">load_data</span> <span class="o">=</span> <span class="n">printer</span><span class="p">(</span><span class="n">load_data</span><span class="p">)</span>
<span class="n">process_data</span> <span class="o">=</span> <span class="n">timer</span><span class="p">(</span><span class="n">process_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>This idiom is common enough to have a built-in language syntax:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@timer</span>
<span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
    <span class="c1"># ... Code ...</span>
    <span class="k">pass</span>

<span class="n">load_data</span><span class="p">(</span><span class="s1">&#39;fname.txt&#39;</span><span class="p">)</span>
<span class="n">load_data</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="s1">&#39;fname.txt&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>It tooks the code 9.5367431640625e-07 milliseconds to run.
It tooks the code 1.1920928955078125e-06 milliseconds to run.
</pre></div>
</div>
</div>
</div>
<p>We can use multiple decorators for functions as well:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@printer</span>
<span class="nd">@timer</span>
<span class="k">def</span> <span class="nf">process_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">shape</span><span class="p">):</span>
    <span class="c1"># ... Code ...</span>
    <span class="k">pass</span>
</pre></div>
</div>
</div>
</div>
<p>When we wish to stop printing and timing our function, we simply delete this decorator in the relevant places.</p>
<p>Decorators allow more complex calls, like calling them with arguments, but we’ll leave that topic for another day.</p>
</div>
<div class="section" id="more-useful-built-in-modules">
<h2>More Useful Built-in Modules<a class="headerlink" href="#more-useful-built-in-modules" title="Permalink to this headline">¶</a></h2>
<p>The Python standard library comes with a number of <a class="reference external" href="https://docs.python.org/3/py-modindex.html">built-in modules</a> that can make your life much easier. As (neuroscience-oriented) data scientists of sorts, you’ll save yourself a lot of hassle by familiarizing yourself with some, namely <code class="docutils literal notranslate"><span class="pre">collections</span></code> and <code class="docutils literal notranslate"><span class="pre">itertools</span></code>. Let’s explore a couple of examples.</p>
<div class="section" id="collections">
<h3><code class="docutils literal notranslate"><span class="pre">collections</span></code><a class="headerlink" href="#collections" title="Permalink to this headline">¶</a></h3>
<div class="section" id="namedtuple">
<h4><code class="docutils literal notranslate"><span class="pre">namedtuple</span></code><a class="headerlink" href="#namedtuple" title="Permalink to this headline">¶</a></h4>
<p>When you want a tiny object with named fields, but without the hassle of creating a fully-fledged class, you actually wish to generate a <code class="docutils literal notranslate"><span class="pre">namedtuple</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>

<span class="n">Point</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Point&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">])</span>
<span class="n">p1</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">p2</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">p3</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">p3</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Point(x=0, y=1)
2
0
</pre></div>
</div>
</div>
</div>
<p>You can access the data inside a <code class="docutils literal notranslate"><span class="pre">namedtuple</span></code> using either the positional index (<code class="docutils literal notranslate"><span class="pre">[0]</span></code>) or the name of that field (<code class="docutils literal notranslate"><span class="pre">x</span></code>). If all you wish to do is to a keep a small record of something, <code class="docutils literal notranslate"><span class="pre">namedtuple</span></code> is your best option.</p>
</div>
<div class="section" id="defaultdict">
<h4><code class="docutils literal notranslate"><span class="pre">defaultdict</span></code><a class="headerlink" href="#defaultdict" title="Permalink to this headline">¶</a></h4>
<p>A <code class="docutils literal notranslate"><span class="pre">defaultdict</span></code> is a dictionary that resorts to execute a predefined function if it doesn’t find the key. For example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">one</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">two</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;three&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyError</span><span class="g g-Whitespace">                                  </span>Traceback (most recent call last)
<span class="nn">Input In [37],</span> in <span class="ni">&lt;cell line: 3&gt;</span><span class="nt">()</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">one</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">two</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="nb">print</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">])</span>
<span class="ne">----&gt; </span><span class="mi">3</span> <span class="nb">print</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;three&#39;</span><span class="p">])</span>

<span class="ne">KeyError</span>: &#39;three&#39;
</pre></div>
</div>
</div>
</div>
<p>Rather than a <code class="docutils literal notranslate"><span class="pre">KeyError</span></code>, a <code class="docutils literal notranslate"><span class="pre">defaultdict</span></code> would run a predefined function instead of raising this exception:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="n">d2</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">one</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">two</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">d2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>defaultdict(list, {&#39;one&#39;: 1, &#39;two&#39;: 2})
</pre></div>
</div>
</div>
</div>
<p>However, when we call it with an unknown key:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">d2</span><span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">d2</span><span class="p">[</span><span class="s1">&#39;three&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1
[]
</pre></div>
</div>
</div>
</div>
<p>It used the <code class="docutils literal notranslate"><span class="pre">list</span></code> “factory” to create a new list in that key. This is particularly useful when sorting some key-value pairs.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;yellow&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;yellow&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
<span class="n">d2</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
    <span class="n">d2</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

<span class="n">d2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>defaultdict(list, {&#39;yellow&#39;: [1, 3], &#39;blue&#39;: [2, 4], &#39;red&#39;: [1]})
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="itertools">
<h3><code class="docutils literal notranslate"><span class="pre">Itertools</span></code><a class="headerlink" href="#itertools" title="Permalink to this headline">¶</a></h3>
<div class="section" id="chained-iterables">
<h4>Chained iterables<a class="headerlink" href="#chained-iterables" title="Permalink to this headline">¶</a></h4>
<p>If we wish to iterate over several iterables together, we can use the following method from the <code class="docutils literal notranslate"><span class="pre">itertools</span></code> module:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">itertools</span>

<span class="n">chained</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="s1">&#39;abcd&#39;</span><span class="p">,</span> <span class="s1">&#39;efg&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">letter</span> <span class="ow">in</span> <span class="n">chained</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">letter</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>a
b
c
d
e
f
g
</pre></div>
</div>
</div>
</div>
<p>Or from an iterable of iterables:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">chained_2</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">]])</span>
<span class="k">for</span> <span class="n">number</span> <span class="ow">in</span> <span class="n">chained_2</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1
2
3
4
5
6
7
8
</pre></div>
</div>
</div>
</div>
<p>Note that <code class="docutils literal notranslate"><span class="pre">itertools</span></code> always creates generators from the items it receives as input.</p>
</div>
<div class="section" id="permutations">
<h4>Permutations<a class="headerlink" href="#permutations" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">permutations</span><span class="p">(</span><span class="s1">&#39;ABCD&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(&#39;A&#39;, &#39;B&#39;),
 (&#39;A&#39;, &#39;C&#39;),
 (&#39;A&#39;, &#39;D&#39;),
 (&#39;B&#39;, &#39;A&#39;),
 (&#39;B&#39;, &#39;C&#39;),
 (&#39;B&#39;, &#39;D&#39;),
 (&#39;C&#39;, &#39;A&#39;),
 (&#39;C&#39;, &#39;B&#39;),
 (&#39;C&#39;, &#39;D&#39;),
 (&#39;D&#39;, &#39;A&#39;),
 (&#39;D&#39;, &#39;B&#39;),
 (&#39;D&#39;, &#39;C&#39;)]
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="combinations">
<h4>Combinations<a class="headerlink" href="#combinations" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="s1">&#39;ABCD&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(&#39;A&#39;, &#39;B&#39;), (&#39;A&#39;, &#39;C&#39;), (&#39;A&#39;, &#39;D&#39;), (&#39;B&#39;, &#39;C&#39;), (&#39;B&#39;, &#39;D&#39;), (&#39;C&#39;, &#39;D&#39;)]
</pre></div>
</div>
</div>
</div>
<p>If you’re looking for more advanced iteration recipes, like chunking, running windows and more, take a look at <a class="reference external" href="https://pypi.org/project/more-itertools/">more-itertools</a> package.</p>
</div>
</div>
</div>
<div class="section" id="multiprocessing">
<h2>Multiprocessing<a class="headerlink" href="#multiprocessing" title="Permalink to this headline">¶</a></h2>
<p>There are several ways to utilize parallel processing in Python. The easiest of all is multi-processing, i.e. the use of several CPU cores to run jobs in parallel. This is best used when each process is independent from the others, not having to share data between them.</p>
<p>A typical use case is when we have a list holding data, or filenames to where the data is, and we wish to perform the same computation on each element of that list. If this computation is truly independent, the <code class="docutils literal notranslate"><span class="pre">multiprocessing</span></code> module has some very easy-to-use solutions.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">multiprocessing</span>

<span class="k">def</span> <span class="nf">add_tuple</span><span class="p">(</span><span class="n">tup</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="n">tups</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">)]</span>
<span class="k">with</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">()</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>  <span class="c1"># can also enter the number of processes you wish to use</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">add_tuple</span><span class="p">,</span> <span class="n">tups</span><span class="p">)</span>
<span class="n">result</span>  <span class="c1"># [1, 5, 9, 13]</span>
</pre></div>
</div>
<p>The code above doesn’t work in IPython and Jupyter (see <a class="reference external" href="https://github.com/ipython/ipyparallel"><code class="docutils literal notranslate"><span class="pre">ipyparallel</span></code></a> for that purpose), but the general idea of using parallel processing in Python is usually something along these lines.</p>
<p>Threading is Python’s weak point because of the <a class="reference external" href="https://wiki.python.org/moin/GlobalInterpreterLock">GIL</a>, and we’ll not discuss it in this class. Another form of parallel processing is asynchronous programming, which we’ll also not cover, but is actually one of Python’s strongest points.</p>
</div>
<div class="section" id="numba">
<h2>Numba<a class="headerlink" href="#numba" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">numba</span></code> is a special library designed to speed-up computations in Python. Let’s jump right into it and then discuss some of the magic afterwards:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">jit</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="nd">@jit</span>
<span class="k">def</span> <span class="nf">sum2d</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
    <span class="n">M</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">result</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Numpy:&quot;</span><span class="p">)</span>
<span class="o">%</span><span class="k">timeit</span> arr.sum()
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Numba:&quot;</span><span class="p">)</span>
<span class="o">%</span><span class="k">timeit</span> sum2d(arr)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Numpy:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>83 ms ± 1.04 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)
Numba:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>133 ms ± 3.43 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
</pre></div>
</div>
</div>
</div>
<p>The results up there are, for lack of a better word, amazing. Numpy has been optimized for ages, works in bare C, and still only offers a mild improvement over <code class="docutils literal notranslate"><span class="pre">numba</span></code>, which seemingly just decorates a simple, perhaps <em>simplistic</em>, Python loop, making it amazingly fast.</p>
<p>This magic happens with <a class="reference external" href="https://llvm.org/">LLVM</a>, an open-source project that aims at building a very fast, cross-language compiler. <code class="docutils literal notranslate"><span class="pre">numba</span></code> translates the Python code into LLVM-suitable code and lets it take care of the optimization details.</p>
<p>Numba has more tricks in its sleeve. You can define the input types and specify <a class="reference external" href="https://numba.pydata.org/numba-doc/latest/user/5minguide.html#what-is-nopython-mode"><code class="docutils literal notranslate"><span class="pre">nopython=True</span></code></a> push performance even further:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">jit</span><span class="p">,</span> <span class="n">float64</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="nd">@jit</span><span class="p">(</span><span class="n">float64</span><span class="p">(</span><span class="n">float64</span><span class="p">[:,</span> <span class="p">:]),</span> <span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">sum2d_inps</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
    <span class="n">M</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Numpy:&quot;</span><span class="p">)</span>
<span class="o">%</span><span class="k">timeit</span> arr.sum()
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Numba:&quot;</span><span class="p">)</span>
<span class="o">%</span><span class="k">timeit</span> sum2d_inps(arr)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Numpy:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>84 ms ± 2.43 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)
Numba:
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>128 ms ± 2.07 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)
</pre></div>
</div>
</div>
</div>
<p>We can also use parallel looping:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">njit</span><span class="p">,</span> <span class="n">prange</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="nd">@njit</span><span class="p">([</span><span class="n">float64</span><span class="p">(</span><span class="n">float64</span><span class="p">[:,</span> <span class="p">:])],</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># njit is equivalent to jit with nopython=True</span>
<span class="k">def</span> <span class="nf">sum2d_p</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
    <span class="n">M</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">M</span><span class="p">):</span> <span class="c1"># Note range was replaced with prange</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> sum2d_p(arr)  # pretty cool
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>68.1 ms ± 1.28 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)
</pre></div>
</div>
</div>
</div>
<p>When implementing long computations heavily based on <code class="docutils literal notranslate"><span class="pre">numpy</span></code> and iterations, <code class="docutils literal notranslate"><span class="pre">numba</span></code> might be the way to go. For very complicated functions that use fancy linear algebra algorithms, it might be the case that <code class="docutils literal notranslate"><span class="pre">numba</span></code> doesn’t support these methods yet. In these occasions resort to basic <code class="docutils literal notranslate"><span class="pre">numpy</span></code> functions and wait till the <code class="docutils literal notranslate"><span class="pre">numba</span></code> developers implement that method, or do so yourself! <code class="docutils literal notranslate"><span class="pre">numba</span></code> is completely open-sourced.</p>
</div>
<div class="section" id="cython">
<h2>Cython<a class="headerlink" href="#cython" title="Permalink to this headline">¶</a></h2>
<p>When you wish to write performant code that utilizes significant parts of the standard library, as well as <code class="docutils literal notranslate"><span class="pre">numpy</span></code> and the scientific stack, neither <code class="docutils literal notranslate"><span class="pre">numpy</span></code> nor <code class="docutils literal notranslate"><span class="pre">numba</span></code> will help you. They require that you work with arrays, which are not as easy to work with as lists, for example. Dictionaries are also very helpful, but using them only with the standard Python interpreter will hinder you performance considerably.</p>
<p>These are the cases where Cython shines. It allows you to write code with Python-like syntax and compile it ahead-of-time to a <code class="docutils literal notranslate"><span class="pre">myfile.c</span></code> source file, written in <code class="docutils literal notranslate"><span class="pre">C</span></code> automatically. When your code calls a function that was written in Cython, it will actually turn to the optimized <code class="docutils literal notranslate"><span class="pre">C</span></code> function and use that function instead.</p>
<p>As stated, Cython requires you to compile your code before running the parent Python script. To do that, you have to create a <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> file that tells the Cython compiler where to find the files in question.</p>
<p>A Cython file ends with <code class="docutils literal notranslate"><span class="pre">X.pyx</span></code>, so <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> should point there. Here’s a basic example of <code class="docutils literal notranslate"><span class="pre">setup.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">distutils.core</span> <span class="kn">import</span> <span class="n">setup</span>
<span class="kn">from</span> <span class="nn">Cython.Build</span> <span class="kn">import</span> <span class="n">cythonize</span>

<span class="n">setup</span><span class="p">(</span>
    <span class="n">ext_modules</span> <span class="o">=</span> <span class="n">cythonize</span><span class="p">(</span><span class="s1">&#39;my_file.pyx&#39;</span><span class="p">),</span>
    <span class="c1"># other setup.py options come here</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Then you navigate with your command line to the folder containing <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> and write <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">setup.py</span> <span class="pre">build_ext</span> <span class="pre">--inplace</span></code>, which tells Cython to “build”, i.e. compile, the code in the <code class="docutils literal notranslate"><span class="pre">.pyx</span></code> file and add it <code class="docutils literal notranslate"><span class="pre">inplace</span></code>, i.e. to this directory.</p>
<p>An example can be found in the <code class="docutils literal notranslate"><span class="pre">cython_demo</span></code> folder. Let’s see it here in action:</p>
<div class="cell tag_remove-input docutils container">
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">cython_demo</span> <span class="kn">import</span> <span class="n">plain_python</span>
<span class="kn">from</span> <span class="nn">cython_demo</span> <span class="kn">import</span> <span class="n">primes_cython</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plain_python</span><span class="o">.</span><span class="n">primes_python</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[2, 3, 5, 7, 11, 13, 17, 19, 23, 29, 31, 37, 41, 43, 47, 53, 59, 61, 67, 71]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">primes_cython</span><span class="o">.</span><span class="n">primes</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[2, 3, 5, 7, 11, 13, 17, 19, 23, 29, 31, 37, 41, 43, 47, 53, 59, 61, 67, 71]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> plain_python.primes_python(1000)
<span class="o">%</span><span class="k">timeit</span> primes_cython.primes(1000)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>34.6 ms ± 555 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.03 ms ± 43 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
</pre></div>
</div>
</div>
</div>
<p>Let’s compare NumPy’s basic performance with the same functionality implemented with <code class="docutils literal notranslate"><span class="pre">numba</span></code> or <code class="docutils literal notranslate"><span class="pre">cython</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rands</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">1000000</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>NumPy:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> rands[rands &lt; 0.5]
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>7.38 ms ± 52.9 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
</pre></div>
</div>
</div>
</div>
<p>Numba:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@njit</span><span class="p">(</span><span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">filter_larger</span><span class="p">(</span><span class="n">rands</span><span class="p">):</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">rands</span><span class="p">)</span>
    <span class="n">thresh</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">last_idx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rands</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">rands</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">arr</span><span class="p">[</span><span class="n">last_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">rands</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">last_idx</span> <span class="o">+=</span> <span class="mi">1</span>
            
    <span class="k">return</span> <span class="n">arr</span><span class="p">[:</span><span class="n">last_idx</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> filter_larger(rands)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3.59 ms ± 828 µs per loop (mean ± std. dev. of 7 runs, 1 loop each)
</pre></div>
</div>
</div>
</div>
<p><em>Note that the <code class="docutils literal notranslate"><span class="pre">last_idx</span></code> variable is probably hindering performance of the parallel loop.</em></p>
<p>Cython:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">cython_filter_demo</span> <span class="kn">import</span> <span class="n">filter_array</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/runner/.pyxbld/temp.linux-x86_64-3.8/pyrex/cython_filter_demo/filter_array.c:687:10: fatal error: numpy/arrayobject.h: No such file or directory
  687 | #include &quot;numpy/arrayobject.h&quot;
      |          ^~~~~~~~~~~~~~~~~~~~~
compilation terminated.
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">DistutilsExecError</span><span class="g g-Whitespace">                        </span>Traceback (most recent call last)
<span class="nn">File /opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/distutils/unixccompiler.py:117,</span> in <span class="ni">UnixCCompiler._compile</span><span class="nt">(self, obj, src, ext, cc_args, extra_postargs, pp_opts)</span>
<span class="g g-Whitespace">    </span><span class="mi">116</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">117</span>     <span class="bp">self</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">compiler_so</span> <span class="o">+</span> <span class="n">cc_args</span> <span class="o">+</span> <span class="p">[</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">]</span> <span class="o">+</span>
<span class="g g-Whitespace">    </span><span class="mi">118</span>                <span class="n">extra_postargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">119</span> <span class="k">except</span> <span class="n">DistutilsExecError</span> <span class="k">as</span> <span class="n">msg</span><span class="p">:</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/distutils/ccompiler.py:910,</span> in <span class="ni">CCompiler.spawn</span><span class="nt">(self, cmd)</span>
<span class="g g-Whitespace">    </span><span class="mi">909</span> <span class="k">def</span> <span class="nf">spawn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">910</span>     <span class="n">spawn</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dry_run</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/distutils/spawn.py:36,</span> in <span class="ni">spawn</span><span class="nt">(cmd, search_path, verbose, dry_run)</span>
<span class="g g-Whitespace">     </span><span class="mi">35</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;posix&#39;</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">36</span>     <span class="n">_spawn_posix</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">search_path</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="n">dry_run</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">37</span> <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;nt&#39;</span><span class="p">:</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/distutils/spawn.py:157,</span> in <span class="ni">_spawn_posix</span><span class="nt">(cmd, search_path, verbose, dry_run)</span>
<span class="g g-Whitespace">    </span><span class="mi">156</span>             <span class="n">cmd</span> <span class="o">=</span> <span class="n">executable</span>
<span class="ne">--&gt; </span><span class="mi">157</span>         <span class="k">raise</span> <span class="n">DistutilsExecError</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">158</span>               <span class="s2">&quot;command </span><span class="si">%r</span><span class="s2"> failed with exit status </span><span class="si">%d</span><span class="s2">&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">159</span>               <span class="o">%</span> <span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">exit_status</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">160</span> <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">WIFSTOPPED</span><span class="p">(</span><span class="n">status</span><span class="p">):</span>

<span class="ne">DistutilsExecError</span>: command &#39;gcc&#39; failed with exit status 1

<span class="n">During</span> <span class="n">handling</span> <span class="n">of</span> <span class="n">the</span> <span class="n">above</span> <span class="n">exception</span><span class="p">,</span> <span class="n">another</span> <span class="n">exception</span> <span class="n">occurred</span><span class="p">:</span>

<span class="ne">CompileError</span><span class="g g-Whitespace">                              </span>Traceback (most recent call last)
<span class="nn">File /opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/site-packages/pyximport/pyximport.py:214,</span> in <span class="ni">load_module</span><span class="nt">(name, pyxfilename, pyxbuild_dir, is_package, build_inplace, language_level, so_path)</span>
<span class="g g-Whitespace">    </span><span class="mi">213</span>         <span class="n">module_name</span> <span class="o">=</span> <span class="n">name</span>
<span class="ne">--&gt; </span><span class="mi">214</span>     <span class="n">so_path</span> <span class="o">=</span> <span class="n">build_module</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">pyxfilename</span><span class="p">,</span> <span class="n">pyxbuild_dir</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">215</span>                            <span class="n">inplace</span><span class="o">=</span><span class="n">build_inplace</span><span class="p">,</span> <span class="n">language_level</span><span class="o">=</span><span class="n">language_level</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">216</span> <span class="n">mod</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">load_dynamic</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">so_path</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/site-packages/pyximport/pyximport.py:186,</span> in <span class="ni">build_module</span><span class="nt">(name, pyxfilename, pyxbuild_dir, inplace, language_level)</span>
<span class="g g-Whitespace">    </span><span class="mi">185</span> <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">pyxbuild</span>
<span class="ne">--&gt; </span><span class="mi">186</span> <span class="n">so_path</span> <span class="o">=</span> <span class="n">pyxbuild</span><span class="o">.</span><span class="n">pyx_to_dll</span><span class="p">(</span><span class="n">pyxfilename</span><span class="p">,</span> <span class="n">extension_mod</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">187</span>                               <span class="n">build_in_temp</span><span class="o">=</span><span class="n">build_in_temp</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">188</span>                               <span class="n">pyxbuild_dir</span><span class="o">=</span><span class="n">pyxbuild_dir</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">189</span>                               <span class="n">setup_args</span><span class="o">=</span><span class="n">sargs</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">190</span>                               <span class="n">inplace</span><span class="o">=</span><span class="n">inplace</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">191</span>                               <span class="n">reload_support</span><span class="o">=</span><span class="n">pyxargs</span><span class="o">.</span><span class="n">reload_support</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">192</span> <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">so_path</span><span class="p">),</span> <span class="s2">&quot;Cannot find: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">so_path</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/site-packages/pyximport/pyxbuild.py:102,</span> in <span class="ni">pyx_to_dll</span><span class="nt">(filename, ext, force_rebuild, build_in_temp, pyxbuild_dir, setup_args, reload_support, inplace)</span>
<span class="g g-Whitespace">    </span><span class="mi">101</span> <span class="n">obj_build_ext</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">get_command_obj</span><span class="p">(</span><span class="s2">&quot;build_ext&quot;</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">102</span> <span class="n">dist</span><span class="o">.</span><span class="n">run_commands</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">103</span> <span class="n">so_path</span> <span class="o">=</span> <span class="n">obj_build_ext</span><span class="o">.</span><span class="n">get_outputs</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/distutils/dist.py:966,</span> in <span class="ni">Distribution.run_commands</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">965</span> <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">commands</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">966</span>     <span class="bp">self</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/distutils/dist.py:985,</span> in <span class="ni">Distribution.run_command</span><span class="nt">(self, command)</span>
<span class="g g-Whitespace">    </span><span class="mi">984</span> <span class="n">cmd_obj</span><span class="o">.</span><span class="n">ensure_finalized</span><span class="p">()</span>
<span class="ne">--&gt; </span><span class="mi">985</span> <span class="n">cmd_obj</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">986</span> <span class="bp">self</span><span class="o">.</span><span class="n">have_run</span><span class="p">[</span><span class="n">command</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/site-packages/Cython/Distutils/old_build_ext.py:186,</span> in <span class="ni">old_build_ext.run</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">184</span>     <span class="n">optimization</span><span class="o">.</span><span class="n">disable_optimization</span><span class="p">()</span>
<span class="ne">--&gt; </span><span class="mi">186</span> <span class="n">_build_ext</span><span class="o">.</span><span class="n">build_ext</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/distutils/command/build_ext.py:340,</span> in <span class="ni">build_ext.run</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">339</span> <span class="c1"># Now actually compile and link everything.</span>
<span class="ne">--&gt; </span><span class="mi">340</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_extensions</span><span class="p">()</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/site-packages/Cython/Distutils/old_build_ext.py:195,</span> in <span class="ni">old_build_ext.build_extensions</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">194</span> <span class="c1"># Call original build_extensions</span>
<span class="ne">--&gt; </span><span class="mi">195</span> <span class="n">_build_ext</span><span class="o">.</span><span class="n">build_ext</span><span class="o">.</span><span class="n">build_extensions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/distutils/command/build_ext.py:449,</span> in <span class="ni">build_ext.build_extensions</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">448</span> <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">449</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_build_extensions_serial</span><span class="p">()</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/distutils/command/build_ext.py:474,</span> in <span class="ni">build_ext._build_extensions_serial</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">473</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_build_errors</span><span class="p">(</span><span class="n">ext</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">474</span>     <span class="bp">self</span><span class="o">.</span><span class="n">build_extension</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/distutils/command/build_ext.py:528,</span> in <span class="ni">build_ext.build_extension</span><span class="nt">(self, ext)</span>
<span class="g g-Whitespace">    </span><span class="mi">526</span>     <span class="n">macros</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">undef</span><span class="p">,))</span>
<span class="ne">--&gt; </span><span class="mi">528</span> <span class="n">objects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span>                                  <span class="n">output_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">build_temp</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">530</span>                                  <span class="n">macros</span><span class="o">=</span><span class="n">macros</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span>                                  <span class="n">include_dirs</span><span class="o">=</span><span class="n">ext</span><span class="o">.</span><span class="n">include_dirs</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span>                                  <span class="n">debug</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">533</span>                                  <span class="n">extra_postargs</span><span class="o">=</span><span class="n">extra_args</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">534</span>                                  <span class="n">depends</span><span class="o">=</span><span class="n">ext</span><span class="o">.</span><span class="n">depends</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">536</span> <span class="c1"># XXX outdated variable, kept here in case third-part code</span>
<span class="g g-Whitespace">    </span><span class="mi">537</span> <span class="c1"># needs it.</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/distutils/ccompiler.py:574,</span> in <span class="ni">CCompiler.compile</span><span class="nt">(self, sources, output_dir, macros, include_dirs, debug, extra_preargs, extra_postargs, depends)</span>
<span class="g g-Whitespace">    </span><span class="mi">573</span>         <span class="k">continue</span>
<span class="ne">--&gt; </span><span class="mi">574</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_compile</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="n">cc_args</span><span class="p">,</span> <span class="n">extra_postargs</span><span class="p">,</span> <span class="n">pp_opts</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">576</span> <span class="c1"># Return *all* object filenames, not just the ones we just built.</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/distutils/unixccompiler.py:120,</span> in <span class="ni">UnixCCompiler._compile</span><span class="nt">(self, obj, src, ext, cc_args, extra_postargs, pp_opts)</span>
<span class="g g-Whitespace">    </span><span class="mi">119</span> <span class="k">except</span> <span class="n">DistutilsExecError</span> <span class="k">as</span> <span class="n">msg</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">120</span>     <span class="k">raise</span> <span class="n">CompileError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

<span class="ne">CompileError</span>: command &#39;gcc&#39; failed with exit status 1

<span class="n">During</span> <span class="n">handling</span> <span class="n">of</span> <span class="n">the</span> <span class="n">above</span> <span class="n">exception</span><span class="p">,</span> <span class="n">another</span> <span class="n">exception</span> <span class="n">occurred</span><span class="p">:</span>

<span class="ne">ImportError</span><span class="g g-Whitespace">                               </span>Traceback (most recent call last)
<span class="nn">Input In [60],</span> in <span class="ni">&lt;cell line: 1&gt;</span><span class="nt">()</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="kn">from</span> <span class="nn">cython_filter_demo</span> <span class="kn">import</span> <span class="n">filter_array</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/site-packages/pyximport/pyximport.py:459,</span> in <span class="ni">PyxLoader.load_module</span><span class="nt">(self, fullname)</span>
<span class="g g-Whitespace">    </span><span class="mi">456</span>     <span class="n">module</span><span class="o">.</span><span class="n">__path__</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">]</span>
<span class="g g-Whitespace">    </span><span class="mi">457</span> <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">458</span>     <span class="c1">#print &quot;MODULE&quot;, fullname</span>
<span class="ne">--&gt; </span><span class="mi">459</span>     <span class="n">module</span> <span class="o">=</span> <span class="n">load_module</span><span class="p">(</span><span class="n">fullname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">460</span>                          <span class="bp">self</span><span class="o">.</span><span class="n">pyxbuild_dir</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">461</span>                          <span class="n">build_inplace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inplace</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">462</span>                          <span class="n">language_level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">language_level</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">463</span> <span class="k">return</span> <span class="n">module</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/site-packages/pyximport/pyximport.py:231,</span> in <span class="ni">load_module</span><span class="nt">(name, pyxfilename, pyxbuild_dir, is_package, build_inplace, language_level, so_path)</span>
<span class="g g-Whitespace">    </span><span class="mi">228</span> <span class="n">exc</span> <span class="o">=</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Building module </span><span class="si">%s</span><span class="s2"> failed: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">229</span>     <span class="n">name</span><span class="p">,</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exception_only</span><span class="p">(</span><span class="o">*</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[:</span><span class="mi">2</span><span class="p">])))</span>
<span class="g g-Whitespace">    </span><span class="mi">230</span> <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">231</span>     <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">with_traceback</span><span class="p">(</span><span class="n">tb</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">232</span> <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">233</span>     <span class="n">exec</span><span class="p">(</span><span class="s2">&quot;raise exc, None, tb&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;exc&#39;</span><span class="p">:</span> <span class="n">exc</span><span class="p">,</span> <span class="s1">&#39;tb&#39;</span><span class="p">:</span> <span class="n">tb</span><span class="p">})</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/site-packages/pyximport/pyximport.py:214,</span> in <span class="ni">load_module</span><span class="nt">(name, pyxfilename, pyxbuild_dir, is_package, build_inplace, language_level, so_path)</span>
<span class="g g-Whitespace">    </span><span class="mi">212</span>     <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">213</span>         <span class="n">module_name</span> <span class="o">=</span> <span class="n">name</span>
<span class="ne">--&gt; </span><span class="mi">214</span>     <span class="n">so_path</span> <span class="o">=</span> <span class="n">build_module</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">pyxfilename</span><span class="p">,</span> <span class="n">pyxbuild_dir</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">215</span>                            <span class="n">inplace</span><span class="o">=</span><span class="n">build_inplace</span><span class="p">,</span> <span class="n">language_level</span><span class="o">=</span><span class="n">language_level</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">216</span> <span class="n">mod</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">load_dynamic</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">so_path</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">217</span> <span class="k">if</span> <span class="n">is_package</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="s1">&#39;__path__&#39;</span><span class="p">):</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/site-packages/pyximport/pyximport.py:186,</span> in <span class="ni">build_module</span><span class="nt">(name, pyxfilename, pyxbuild_dir, inplace, language_level)</span>
<span class="g g-Whitespace">    </span><span class="mi">183</span> <span class="n">build_in_temp</span> <span class="o">=</span> <span class="n">sargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;build_in_temp&#39;</span><span class="p">,</span><span class="n">build_in_temp</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">185</span> <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">pyxbuild</span>
<span class="ne">--&gt; </span><span class="mi">186</span> <span class="n">so_path</span> <span class="o">=</span> <span class="n">pyxbuild</span><span class="o">.</span><span class="n">pyx_to_dll</span><span class="p">(</span><span class="n">pyxfilename</span><span class="p">,</span> <span class="n">extension_mod</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">187</span>                               <span class="n">build_in_temp</span><span class="o">=</span><span class="n">build_in_temp</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">188</span>                               <span class="n">pyxbuild_dir</span><span class="o">=</span><span class="n">pyxbuild_dir</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">189</span>                               <span class="n">setup_args</span><span class="o">=</span><span class="n">sargs</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">190</span>                               <span class="n">inplace</span><span class="o">=</span><span class="n">inplace</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">191</span>                               <span class="n">reload_support</span><span class="o">=</span><span class="n">pyxargs</span><span class="o">.</span><span class="n">reload_support</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">192</span> <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">so_path</span><span class="p">),</span> <span class="s2">&quot;Cannot find: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">so_path</span>
<span class="g g-Whitespace">    </span><span class="mi">194</span> <span class="n">junkpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">so_path</span><span class="p">),</span> <span class="n">name</span><span class="o">+</span><span class="s2">&quot;_*&quot;</span><span class="p">)</span> <span class="c1">#very dangerous with --inplace ? yes, indeed, trying to eat my files ;)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/site-packages/pyximport/pyxbuild.py:102,</span> in <span class="ni">pyx_to_dll</span><span class="nt">(filename, ext, force_rebuild, build_in_temp, pyxbuild_dir, setup_args, reload_support, inplace)</span>
<span class="g g-Whitespace">    </span><span class="mi">100</span> <span class="k">try</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">101</span>     <span class="n">obj_build_ext</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">get_command_obj</span><span class="p">(</span><span class="s2">&quot;build_ext&quot;</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">102</span>     <span class="n">dist</span><span class="o">.</span><span class="n">run_commands</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">103</span>     <span class="n">so_path</span> <span class="o">=</span> <span class="n">obj_build_ext</span><span class="o">.</span><span class="n">get_outputs</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<span class="g g-Whitespace">    </span><span class="mi">104</span>     <span class="k">if</span> <span class="n">obj_build_ext</span><span class="o">.</span><span class="n">inplace</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">105</span>         <span class="c1"># Python distutils get_outputs()[ returns a wrong so_path</span>
<span class="g g-Whitespace">    </span><span class="mi">106</span>         <span class="c1"># when --inplace ; see http://bugs.python.org/issue5977</span>
<span class="g g-Whitespace">    </span><span class="mi">107</span>         <span class="c1"># workaround:</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/distutils/dist.py:966,</span> in <span class="ni">Distribution.run_commands</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">961</span> <span class="sd">&quot;&quot;&quot;Run each command that was seen on the setup script command line.</span>
<span class="g g-Whitespace">    </span><span class="mi">962</span><span class="sd"> Uses the list of commands found and cache of command objects</span>
<span class="g g-Whitespace">    </span><span class="mi">963</span><span class="sd"> created by &#39;get_command_obj()&#39;.</span>
<span class="g g-Whitespace">    </span><span class="mi">964</span><span class="sd"> &quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">965</span> <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">commands</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">966</span>     <span class="bp">self</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/distutils/dist.py:985,</span> in <span class="ni">Distribution.run_command</span><span class="nt">(self, command)</span>
<span class="g g-Whitespace">    </span><span class="mi">983</span> <span class="n">cmd_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_command_obj</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">984</span> <span class="n">cmd_obj</span><span class="o">.</span><span class="n">ensure_finalized</span><span class="p">()</span>
<span class="ne">--&gt; </span><span class="mi">985</span> <span class="n">cmd_obj</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">986</span> <span class="bp">self</span><span class="o">.</span><span class="n">have_run</span><span class="p">[</span><span class="n">command</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/site-packages/Cython/Distutils/old_build_ext.py:186,</span> in <span class="ni">old_build_ext.run</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">182</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cython_gdb</span> <span class="ow">or</span> <span class="p">[</span><span class="mi">1</span> <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extensions</span>
<span class="g g-Whitespace">    </span><span class="mi">183</span>                              <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="s1">&#39;cython_gdb&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)]:</span>
<span class="g g-Whitespace">    </span><span class="mi">184</span>     <span class="n">optimization</span><span class="o">.</span><span class="n">disable_optimization</span><span class="p">()</span>
<span class="ne">--&gt; </span><span class="mi">186</span> <span class="n">_build_ext</span><span class="o">.</span><span class="n">build_ext</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/distutils/command/build_ext.py:340,</span> in <span class="ni">build_ext.run</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">337</span>     <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">set_link_objects</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">link_objects</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">339</span> <span class="c1"># Now actually compile and link everything.</span>
<span class="ne">--&gt; </span><span class="mi">340</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_extensions</span><span class="p">()</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/site-packages/Cython/Distutils/old_build_ext.py:195,</span> in <span class="ni">old_build_ext.build_extensions</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">193</span>     <span class="n">ext</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cython_sources</span><span class="p">(</span><span class="n">ext</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">194</span> <span class="c1"># Call original build_extensions</span>
<span class="ne">--&gt; </span><span class="mi">195</span> <span class="n">_build_ext</span><span class="o">.</span><span class="n">build_ext</span><span class="o">.</span><span class="n">build_extensions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/distutils/command/build_ext.py:449,</span> in <span class="ni">build_ext.build_extensions</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">447</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_build_extensions_parallel</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">448</span> <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">449</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_build_extensions_serial</span><span class="p">()</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/distutils/command/build_ext.py:474,</span> in <span class="ni">build_ext._build_extensions_serial</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">472</span> <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extensions</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">473</span>     <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_build_errors</span><span class="p">(</span><span class="n">ext</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">474</span>         <span class="bp">self</span><span class="o">.</span><span class="n">build_extension</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/distutils/command/build_ext.py:528,</span> in <span class="ni">build_ext.build_extension</span><span class="nt">(self, ext)</span>
<span class="g g-Whitespace">    </span><span class="mi">525</span> <span class="k">for</span> <span class="n">undef</span> <span class="ow">in</span> <span class="n">ext</span><span class="o">.</span><span class="n">undef_macros</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">526</span>     <span class="n">macros</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">undef</span><span class="p">,))</span>
<span class="ne">--&gt; </span><span class="mi">528</span> <span class="n">objects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span>                                  <span class="n">output_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">build_temp</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">530</span>                                  <span class="n">macros</span><span class="o">=</span><span class="n">macros</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span>                                  <span class="n">include_dirs</span><span class="o">=</span><span class="n">ext</span><span class="o">.</span><span class="n">include_dirs</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span>                                  <span class="n">debug</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">533</span>                                  <span class="n">extra_postargs</span><span class="o">=</span><span class="n">extra_args</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">534</span>                                  <span class="n">depends</span><span class="o">=</span><span class="n">ext</span><span class="o">.</span><span class="n">depends</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">536</span> <span class="c1"># XXX outdated variable, kept here in case third-part code</span>
<span class="g g-Whitespace">    </span><span class="mi">537</span> <span class="c1"># needs it.</span>
<span class="g g-Whitespace">    </span><span class="mi">538</span> <span class="bp">self</span><span class="o">.</span><span class="n">_built_objects</span> <span class="o">=</span> <span class="n">objects</span><span class="p">[:]</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/distutils/ccompiler.py:574,</span> in <span class="ni">CCompiler.compile</span><span class="nt">(self, sources, output_dir, macros, include_dirs, debug, extra_preargs, extra_postargs, depends)</span>
<span class="g g-Whitespace">    </span><span class="mi">572</span>     <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">573</span>         <span class="k">continue</span>
<span class="ne">--&gt; </span><span class="mi">574</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_compile</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="n">cc_args</span><span class="p">,</span> <span class="n">extra_postargs</span><span class="p">,</span> <span class="n">pp_opts</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">576</span> <span class="c1"># Return *all* object filenames, not just the ones we just built.</span>
<span class="g g-Whitespace">    </span><span class="mi">577</span> <span class="k">return</span> <span class="n">objects</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/distutils/unixccompiler.py:120,</span> in <span class="ni">UnixCCompiler._compile</span><span class="nt">(self, obj, src, ext, cc_args, extra_postargs, pp_opts)</span>
<span class="g g-Whitespace">    </span><span class="mi">117</span>     <span class="bp">self</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">compiler_so</span> <span class="o">+</span> <span class="n">cc_args</span> <span class="o">+</span> <span class="p">[</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">]</span> <span class="o">+</span>
<span class="g g-Whitespace">    </span><span class="mi">118</span>                <span class="n">extra_postargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">119</span> <span class="k">except</span> <span class="n">DistutilsExecError</span> <span class="k">as</span> <span class="n">msg</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">120</span>     <span class="k">raise</span> <span class="n">CompileError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

<span class="ne">ImportError</span>: Building module cython_filter_demo.filter_array failed: [&quot;distutils.errors.CompileError: command &#39;gcc&#39; failed with exit status 1\n&quot;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> filter_array.filter_larger_cython(rands)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="nn">Input In [61],</span> in <span class="ni">&lt;cell line: 1&gt;</span><span class="nt">()</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">get_ipython</span><span class="p">()</span><span class="o">.</span><span class="n">run_line_magic</span><span class="p">(</span><span class="s1">&#39;timeit&#39;</span><span class="p">,</span> <span class="s1">&#39;filter_array.filter_larger_cython(rands)&#39;</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/site-packages/IPython/core/interactiveshell.py:2294,</span> in <span class="ni">InteractiveShell.run_line_magic</span><span class="nt">(self, magic_name, line, _stack_depth)</span>
<span class="g g-Whitespace">   </span><span class="mi">2292</span>     <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;local_ns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_local_scope</span><span class="p">(</span><span class="n">stack_depth</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2293</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">builtin_trap</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">2294</span>     <span class="n">result</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2295</span> <span class="k">return</span> <span class="n">result</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/site-packages/IPython/core/magics/execution.py:1162,</span> in <span class="ni">ExecutionMagics.timeit</span><span class="nt">(self, line, cell, local_ns)</span>
<span class="g g-Whitespace">   </span><span class="mi">1160</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
<span class="g g-Whitespace">   </span><span class="mi">1161</span>     <span class="n">number</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">index</span>
<span class="ne">-&gt; </span><span class="mi">1162</span>     <span class="n">time_number</span> <span class="o">=</span> <span class="n">timer</span><span class="o">.</span><span class="n">timeit</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1163</span>     <span class="k">if</span> <span class="n">time_number</span> <span class="o">&gt;=</span> <span class="mf">0.2</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1164</span>         <span class="k">break</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/site-packages/IPython/core/magics/execution.py:156,</span> in <span class="ni">Timer.timeit</span><span class="nt">(self, number)</span>
<span class="g g-Whitespace">    </span><span class="mi">154</span> <span class="n">gc</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">155</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">156</span>     <span class="n">timing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">157</span> <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">158</span>     <span class="k">if</span> <span class="n">gcold</span><span class="p">:</span>

<span class="nn">File &lt;magic-timeit&gt;:1,</span> in <span class="ni">inner</span><span class="nt">(_it, _timer)</span>

<span class="ne">NameError</span>: name &#39;filter_array&#39; is not defined
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="memoization-caching">
<h2>Memoization (Caching)<a class="headerlink" href="#memoization-caching" title="Permalink to this headline">¶</a></h2>
<p>Yet another way to improve performance of your scripts, perhaps a more straight-forward one, is memoization. This essentially means caching (saving) the results of computations done for a given set of parameters. Every time the function is called it first checks whether the result of the operation was already computed earlier, and if so it immediately returns it rather than re-computing it all over again.</p>
<p>Caching is extremely easy to do in Python. The standard library includes a module called <code class="docutils literal notranslate"><span class="pre">functools</span></code> which contains several important functions that work on other functions, and one of them is <code class="docutils literal notranslate"><span class="pre">lru_cache</span></code>, which stands for “least recently used”. While it’s not the only way to do memoization in Python (there are multiple 3rd partly libraries that implement fancy memoization techniques), <code class="docutils literal notranslate"><span class="pre">lru_cache</span></code> is usually good enough.</p>
<p>Using it is extremely simple:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fib</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the *n*th Fibonacci sequence element.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n : int</span>
<span class="sd">        Index of the desired Fibonacci number</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        The value of the *n*th Fibonacci number</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">n</span>
    <span class="k">return</span> <span class="n">fib</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">fib</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The Fibonacci series is a classic example, since every computation of a new element in the sequence is built on previous calculations. The function above is a simple implementation using recursion, but it currently doesn’t cache its result. Meaning that it has to re-compute all values whenever its called.</p>
<p>To cache the result we simply have to add a decorator to it:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">functools</span>


<span class="nd">@functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">fib</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the *n*th Fibonacci sequence element.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n : int</span>
<span class="sd">        Index of the desired Fibonacci number</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        The value of the *n*th Fibonacci number</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">n</span>
    <span class="k">return</span> <span class="n">fib</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">fib</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s look at the timings:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> -n1 -r1 fib(60)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>39.3 µs ± 0 ns per loop (mean ± std. dev. of 1 run, 1 loop each)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> -n1 -r1 fib(61)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3.1 µs ± 0 ns per loop (mean ± std. dev. of 1 run, 1 loop each)
</pre></div>
</div>
</div>
</div>
<p>Running <code class="docutils literal notranslate"><span class="pre">fib(61)</span></code> takes almost no time, since the result of <code class="docutils literal notranslate"><span class="pre">fib(60)</span></code> is already cached.</p>
</div>
<div class="section" id="code-smells">
<h2>“Code Smells”<a class="headerlink" href="#code-smells" title="Permalink to this headline">¶</a></h2>
<p>We’ll now turn our attention to higher-minded concepts that you should pay attention to when creating software. The term above refers to elements in your code base that represent something which is not <em>wrong</em>, but can probably be better. That’s what the “smell” means - it’s like a bad feeling about the code, but it’s not something which will tear down your application if it remains as is.</p>
<div class="section" id="repetitive-code">
<h3>Repetitive code<a class="headerlink" href="#repetitive-code" title="Permalink to this headline">¶</a></h3>
<p>The rule of thumb here is once you understand that some piece of code will be re-used somewhere else, immediately extract it out into a function and call that function instead. This will help you test it for correctness, document it more thoroughly and improve the readability of the piece of code using this new function.</p>
<p>Consider the following made-up snippets from some fantastic analysis:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">tifffile</span>


<span class="c1"># ...</span>
<span class="c1"># In the middle of some data analysis script</span>
<span class="n">file_list_type_1</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;a.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;b.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;c.tif&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">file_list_type_1</span><span class="p">:</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">tifffile</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">-=</span> <span class="n">img</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">img</span> <span class="o">/=</span> <span class="n">img</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

<span class="c1"># ...</span>
<span class="n">file_list_type_2</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;x.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;y.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;z.tif&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">file_list_type_2</span><span class="p">:</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">tifffile</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">-=</span> <span class="n">img</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">img</span> <span class="o">/=</span> <span class="n">img</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</pre></div>
</div>
<p>I can definitely smell something. Let’s try:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="k">def</span> <span class="nf">normalize_image</span><span class="p">(</span><span class="n">image</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    Receives an image in the form of a numpy array, makes </span>
<span class="sd">    it positive and normalizes it between 0 and 1.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image : np.ndarray</span>
<span class="sd">        Image to be normalized</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Normalized image</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">img</span> <span class="o">-=</span> <span class="n">img</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">img</span> <span class="o">/=</span> <span class="n">img</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">img</span>

<span class="c1"># ...</span>
<span class="n">file_list_type_1</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;a.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;b.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;c.tif&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">file_list_type_1</span><span class="p">:</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">tifffile</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">normalize_img</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

<span class="c1"># ...</span>
<span class="n">file_list_type_2</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;x.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;y.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;z.tif&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">file_list_type_2</span><span class="p">:</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">tifffile</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">normalize_img</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</pre></div>
</div>
<p>Even though the code in question is only two lines long, I decided to extract it into its own function. Besides the increased readability, I may have noticed in a later stage of my coding that this function isn’t as harmless as it seems due to a possible <strong>integer overflow.</strong> (<code class="docutils literal notranslate"><span class="pre">ZeroDivisionError</span></code>) So now the function is longer than two lines, and more tests have to be added. Coding these upgrades in the first case, where we didn’t extract the code snippet, would’ve been double the work with a higher chance for bugs.</p>
</div>
<div class="section" id="long-functions-with-block-comments">
<h3>Long functions (with “block comments”)<a class="headerlink" href="#long-functions-with-block-comments" title="Permalink to this headline">¶</a></h3>
<p>Ideally, functions should be about 10-20 lines long in total, including documentation. I.e. a single function or method shouldn’t be longer than your screen. There’s no lower-bound limit, meaning that very short functions where the code is 2-3 lines long, as seen above, are absolutely fine.</p>
<p>Long functions are hard to understand, hard to test and will usually contain several blocks with distinct purposes. There’s absolutely no reason to group up blocks that have different “responsibilities” in a single function. On occasions in which we <em>do</em> write these long functions, we sometimes like to add block comments to the function, like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">###################################################</span>
<span class="c1"># This part deals with reading the data into memory</span>
<span class="c1">###################################################</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">tiffile</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="c1"># ...</span>

<span class="c1">#############################################</span>
<span class="c1"># Find the active areas in the processed data</span>
<span class="c1">#############################################</span>
<span class="c1"># ...</span>

</pre></div>
</div>
<p>Here’s a contrived example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_data</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="c1"># Checks for validity of data and reads it</span>
    <span class="k">assert</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
    <span class="n">raw</span> <span class="o">=</span> <span class="n">tifffile</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">raw</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="k">assert</span> <span class="n">raw</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span>
    
    <span class="c1"># Now we process the data</span>
    <span class="n">summed</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">summed</span> <span class="o">=</span> <span class="p">(</span><span class="n">summed</span> <span class="o">-</span> <span class="n">summed</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
    <span class="n">summed</span> <span class="o">/=</span> <span class="n">summed</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    
    <span class="c1"># ...</span>
</pre></div>
</div>
</div>
</div>
<p>It should be clear to you that each of the code blocks, annotated by a comment, should be a different function.</p>
</div>
<div class="section" id="objects-that-should-be-functions-functions-that-should-be-objects">
<h3>Objects that should be functions, functions that should be objects<a class="headerlink" href="#objects-that-should-be-functions-functions-that-should-be-objects" title="Permalink to this headline">¶</a></h3>
<p>A “healthy” code base will contain a mix of objects (with their methods) and functions. Using only one of these programming paradigms in a medium-to-large scale project is probably not the way to go. But how do you decide whether some code has to go into a function, or “deserves” it’s own object? Here are a couple of thumb rules:</p>
<div class="section" id="long-list-of-arguments">
<h4>Long list of arguments<a class="headerlink" href="#long-list-of-arguments" title="Permalink to this headline">¶</a></h4>
<p>Whenever an algorithm has several functions that perform a task back to back, and they all take approximately the same argumets (number of pixels in the image, filename, the data array, etc.) then you should probably turn these functions into methods in an object, and just ditch the arguments by using <code class="docutils literal notranslate"><span class="pre">self</span></code>.</p>
<p>This refactoring into an object will also let you organize the code and improve its readability. As separate functions you might not remember who do you call first - do I first <code class="docutils literal notranslate"><span class="pre">divide_by_largest()</span></code> and then <code class="docutils literal notranslate"><span class="pre">find_most_popular()</span></code> or the other way around? As methods in an object you can sort them in a <code class="docutils literal notranslate"><span class="pre">main()</span></code>, publically-available method which exposes the only true way to use these functions.</p>
</div>
<div class="section" id="objects-with-either-one-or-two-methods">
<h4>Objects with either one or two methods<a class="headerlink" href="#objects-with-either-one-or-two-methods" title="Permalink to this headline">¶</a></h4>
<p>Usually if you have an object which has no more than a couple of methods, it’s best to just turn these methods into functions and use them instead. Objects create more boilerplate and clutter, and testing will be generally harder.</p>
</div>
<div class="section" id="hard-to-explain">
<h4>Hard to explain<a class="headerlink" href="#hard-to-explain" title="Permalink to this headline">¶</a></h4>
<p>This one might sound naive or simplistic, but it’s profoundly true. When things are engineered correctly, they are easier to explain. Try to spend time considering the purpose of each distinguishable building block of your code, how it interacts with the other pieces, what information it requires, what other parts of your code make use of this information, how else are they related, etc. With enough practice, you’ll find that the way you write code in the first place changes and requires less revisions and rewrites every time something in your workflow changes.</p>
</div>
</div>
<div class="section" id="too-many-nested-levels">
<h3>Too many nested levels<a class="headerlink" href="#too-many-nested-levels" title="Permalink to this headline">¶</a></h3>
<p>Having too many nested levels in your code gives the readers of it a harder time - they have to remember the last condition that was met (or wasn’t), and to understand its relation to the current condition. But how do we do that? We have two main methods: early returns and “switch-like” statements.</p>
<div class="section" id="early-returns">
<h4>Early returns<a class="headerlink" href="#early-returns" title="Permalink to this headline">¶</a></h4>
<p><strong>BAD CODE BELOW</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="n">b</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">func1</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;C is </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">item</span> <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">d</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">func1</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;C is </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
                <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">item</span> <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">d</span>
</pre></div>
</div>
</div>
</div>
<p>It would be better to:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">func1</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;C is </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
        <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">item</span> <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">d</span>
</pre></div>
</div>
</div>
</div>
<p>There are two main differences here:</p>
<ul class="simple">
<li><p>The use of the built-in <code class="docutils literal notranslate"><span class="pre">max()</span></code> function to drop the first <code class="docutils literal notranslate"><span class="pre">if</span></code> statements, since the two code paths are identical.</p></li>
<li><p>“Early” <code class="docutils literal notranslate"><span class="pre">return</span></code>. Instead of asking <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">c:</span></code> and then having a fully-indented code block below, we reverse the condition, asking <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">not</span> <span class="pre">c:</span> <span class="pre">return</span> <span class="pre">None</span></code>, and then we can safely unindent the following code path, since we’re sure that <code class="docutils literal notranslate"><span class="pre">c</span></code> has the right value for us. It’s also easier to read, since you can remember that for all lines of code below the <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">not</span> <span class="pre">c</span></code> condition, <code class="docutils literal notranslate"><span class="pre">c</span></code> is not <code class="docutils literal notranslate"><span class="pre">False</span></code> or <code class="docutils literal notranslate"><span class="pre">None</span></code>, there are no <code class="docutils literal notranslate"><span class="pre">else</span></code> clauses that would make it less obvious was condition are we really checking at this line of code.</p></li>
</ul>
</div>
<div class="section" id="switch-like-statement-in-python">
<h4>Switch-like statement in Python<a class="headerlink" href="#switch-like-statement-in-python" title="Permalink to this headline">¶</a></h4>
<p>Progammers in other languages, including MATLAB, are usually aware of the <code class="docutils literal notranslate"><span class="pre">switch</span> <span class="pre">-</span> <span class="pre">case</span></code> operator which allows you to choose what to do based on a specific value of some variable during runtime. For example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">my_func1</span><span class="p">():</span>
    <span class="k">return</span> <span class="mi">4</span>

<span class="k">def</span> <span class="nf">my_func2</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data is </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">my_func3</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
</div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">my_func1</span><span class="p">()</span>
<span class="n">switch</span> <span class="n">data</span><span class="p">:</span>
    <span class="k">case</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">my_func2</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">case</span> <span class="mi">15</span><span class="p">:</span>
        <span class="n">my_func3</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="c1"># etc...</span>
</pre></div>
</div>
<p><strike>Python doesn’t have a proper switch statement</strike>, but you can mimick this behavior using dictionaries! Here’s an equivalent piece of code:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">switch</span> <span class="o">=</span> <span class="p">{</span><span class="mi">4</span><span class="p">:</span> <span class="n">my_func2</span><span class="p">,</span> <span class="mi">15</span><span class="p">:</span> <span class="n">my_func3</span><span class="p">}</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">my_func1</span><span class="p">()</span>
<span class="n">switch</span><span class="p">[</span><span class="n">data</span><span class="p">](</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Data is 4
</pre></div>
</div>
</div>
</div>
<p>When we access the <code class="docutils literal notranslate"><span class="pre">switch</span></code> dictionary at the index <code class="docutils literal notranslate"><span class="pre">data</span></code>, we get back the name of the function which was mapped there. This is like running the following statement:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="n">my_func3</span>
<span class="n">a</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;function __main__.my_func3(data)&gt;
</pre></div>
</div>
</div>
</div>
<p>The variable <code class="docutils literal notranslate"><span class="pre">a</span></code> is just a reference to the function. Printing it doesn’t call the function, we have to add parenthesis in order for the function to be executed. And this is why we have the <code class="docutils literal notranslate"><span class="pre">(data)</span></code> part after <code class="docutils literal notranslate"><span class="pre">switch[data]</span></code> - the parenthesis, with the argument inside them, make the actual function call happen.</p>
<p>Switch statements aren’t too common out in the wild, but sometimes they fit best your mental model of your code. When that is the case, a dictionary is a suitable replacement for the missing <code class="docutils literal notranslate"><span class="pre">switch</span></code>. By the way, there are libraries which try to mimick a <code class="docutils literal notranslate"><span class="pre">switch</span></code> in a clearer manner.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Python 3.10 introduced switch statements, so if you <em>really</em> don’t want to use a dictionary go ahead and:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">match</span> <span class="n">x</span><span class="p">:</span>
        <span class="k">case</span> <span class="s1">&#39;a&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">case</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="software-design-principles">
<h2>Software Design Principles<a class="headerlink" href="#software-design-principles" title="Permalink to this headline">¶</a></h2>
<p>The previous part dealt with low-level concepts with very clear “do’s and don’ts”. We’ll now turn our heads to some higher-level concepts when you think of the design of your software. Most of the ideas presented below are from Robert Martin’s, AKA Uncle Bob, lectures and textbooks. He’s one of the founding fathers of object-oriented design.</p>
<div class="section" id="object-orthogonality-and-encapsulation">
<h3>Object Orthogonality and Encapsulation<a class="headerlink" href="#object-orthogonality-and-encapsulation" title="Permalink to this headline">¶</a></h3>
<p>In many cases objects interact with one another. In the case of some <code class="docutils literal notranslate"><span class="pre">ProcessData</span></code> class, which might process some instances of a <code class="docutils literal notranslate"><span class="pre">Data</span></code> class, that can contain a couple of <code class="docutils literal notranslate"><span class="pre">Series</span></code> and metadata, for example, we can see how <code class="docutils literal notranslate"><span class="pre">ProcessData</span></code> communicates with the data inside the <code class="docutils literal notranslate"><span class="pre">Data</span></code> class, modifying it further.</p>
<p>A preliminary design might look like the following:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>


<span class="k">class</span> <span class="nc">Data</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; Simple container for DataFrames and their metadata &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr1</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">arr2</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">date</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ser1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">arr1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ser2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">arr2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">shape1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ser1</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                                 <span class="n">shape2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ser2</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                                 <span class="n">total</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ser1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                 <span class="n">date</span><span class="o">=</span><span class="n">date</span><span class="p">)</span>

            
<span class="k">class</span> <span class="nc">ProcessData</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; Pipeline to process twin Data instances &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data1</span><span class="p">:</span> <span class="n">Data</span><span class="p">,</span> <span class="n">data2</span><span class="p">:</span> <span class="n">Data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data1</span> <span class="o">=</span> <span class="n">data1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data2</span> <span class="o">=</span> <span class="n">data2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">columns1</span><span class="o">=</span><span class="n">data1</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
                             <span class="n">columns2</span><span class="o">=</span><span class="n">data2</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
                             <span class="n">metadata</span><span class="o">=</span><span class="n">data1</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">data1</span><span class="o">.</span><span class="n">ser1</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="n">data2</span><span class="o">.</span><span class="n">ser1</span><span class="o">.</span><span class="n">sum</span><span class="p">()])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">data1</span><span class="o">.</span><span class="n">ser1</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">+</span> <span class="n">data2</span><span class="o">.</span><span class="n">ser2</span><span class="o">.</span><span class="n">mean</span><span class="p">()])</span>
        <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
</div>
</div>
<p>We have here a <code class="docutils literal notranslate"><span class="pre">Data</span></code> class which serves as a container for two DataFrames that are logically connected. It also simplifies the access to some of the metadata contained with theses DataFrames.</p>
<p>We also have a <code class="docutils literal notranslate"><span class="pre">ProcessData</span></code> class that uses the <code class="docutils literal notranslate"><span class="pre">Data</span></code> instances to calculate some statistical properties and keep them for later use.</p>
<p>While this design works (which is important), it’s flawed in the sense that the <code class="docutils literal notranslate"><span class="pre">ProcessData</span></code> object is highly dependent on the implementation details of the <code class="docutils literal notranslate"><span class="pre">Data</span></code> class. How would you write tests for <code class="docutils literal notranslate"><span class="pre">ProcessData</span></code>? Many of the possible tests you may write are reliant on proper <code class="docutils literal notranslate"><span class="pre">Data</span></code> implementation. When higher-level objects are dependent on specific attributes of some lower-level module, we need to perform <a class="reference external" href="https://en.wikipedia.org/wiki/Dependency_inversion_principle">“dependency inversion”</a>. This decoupling process can also be called “object orthogonality”.</p>
<p>We’ll do a couple of major changes to our design which will solve, step by step, the design issues we encoutered.</p>
<p>First we’ll create a new <code class="docutils literal notranslate"><span class="pre">DataContainer</span></code> class that holds <code class="docutils literal notranslate"><span class="pre">Data</span></code> instances, and redefine the <code class="docutils literal notranslate"><span class="pre">Data</span></code> class more appropriately:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Data</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; Simple container for DataFrames and their metadata &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr1</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">arr2</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">date</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ser1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">arr1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ser2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">arr2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">shape1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df1</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                                 <span class="n">shape2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df2</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                                 <span class="n">total</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">df2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                 <span class="n">date</span><span class="o">=</span><span class="n">date</span><span class="p">)</span>
        
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the actual data variables as an iterable&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ser1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ser2</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span>
    
    <span class="k">def</span> <span class="nf">sum</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">DataContainer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; Holds, in order, instances of Data &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datas</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">datas</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">Data</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">metadata</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TypeError: Data </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2"> isn&#39;t a &#39;Data&#39; type.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span>
    
    <span class="k">def</span> <span class="nf">sum</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
</div>
</div>
<p>First note the “new technical term”: We introduce here the <code class="docutils literal notranslate"><span class="pre">&#64;property</span></code> decorators. If we define some method as a property, that keyword can be used like a regular attribute, except for the fact that it’s immutable:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Trial</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">two_as_attr</span> <span class="o">=</span> <span class="mi">2</span>
    
    <span class="k">def</span> <span class="nf">two_as_method</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">2</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">two_as_prop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">2</span>

<span class="n">tr</span> <span class="o">=</span> <span class="n">Trial</span><span class="p">()</span>

<span class="c1"># Changing attributes is possible:</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The original attribute: </span><span class="si">{</span><span class="n">tr</span><span class="o">.</span><span class="n">two_as_attr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">tr</span><span class="o">.</span><span class="n">two_as_attr</span> <span class="o">=</span> <span class="mi">3</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attributes can be changed: </span><span class="si">{</span><span class="n">tr</span><span class="o">.</span><span class="n">two_as_attr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;------&quot;</span><span class="p">)</span>

<span class="c1"># Using the regular method requires brackets</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using the method: </span><span class="si">{</span><span class="n">tr</span><span class="o">.</span><span class="n">two_as_method</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;And of course, it can&#39;t be changed (though you could override the function).&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;------&quot;</span><span class="p">)</span>

<span class="c1"># Using a property &quot;feels&quot; like using an attributes:</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;As a property: </span><span class="si">{</span><span class="n">tr</span><span class="o">.</span><span class="n">two_as_prop</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># no brackets</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">tr</span><span class="o">.</span><span class="n">two_as_prop</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># AttributeError</span>
<span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AttributeError: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> - properties can&#39;t (by default) be changed.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The original attribute: 2
Attributes can be changed: 3
------
Using the method: 2
And of course, it can&#39;t be changed (though you could override the function).
------
As a property: 2
AttributeError: can&#39;t set attribute - properties can&#39;t (by default) be changed.
</pre></div>
</div>
</div>
</div>
<p>But besides this new, exciting feature of Python, what else has changed with the implementation?</p>
<div class="section" id="data">
<h4><code class="docutils literal notranslate"><span class="pre">Data</span></code>:<a class="headerlink" href="#data" title="Permalink to this headline">¶</a></h4>
<ol class="simple">
<li><p>We redefined <code class="docutils literal notranslate"><span class="pre">Data</span></code>. The new object doesn’t allow anyone from the outside to change the data it holds, it only allows for a “view” of the data. The use of properties ensure that once the object was created, the internal structure of the instance remains intact. The single underscore before the variable names also prevents direct access to the attribute. This idea is called <em>encapsulation</em>.</p></li>
<li><p>Furthermore, if we examine the <code class="docutils literal notranslate"><span class="pre">sum()</span></code> method, we see that it’s now bound to the <code class="docutils literal notranslate"><span class="pre">Data</span></code> object itself. If we write it explicitly it makes senes: <em>The sum of the data is a bound method to our data - an intrinsic property of it.</em> If we ever decide to change how our data is stored, the <code class="docutils literal notranslate"><span class="pre">sum()</span></code> method should change accordingly, but no other object will be affected.</p></li>
</ol>
</div>
<div class="section" id="datacontainer">
<h4><code class="docutils literal notranslate"><span class="pre">DataContainer</span></code>:<a class="headerlink" href="#datacontainer" title="Permalink to this headline">¶</a></h4>
<ol class="simple">
<li><p>The new <code class="docutils literal notranslate"><span class="pre">DataContainer</span></code> class <em>doesn’t really know</em> what it’s holding. All it cares is that they’re <code class="docutils literal notranslate"><span class="pre">Data</span></code> instances. It doesn’t peek inside the methods of the different <code class="docutils literal notranslate"><span class="pre">Data</span></code> instances.</p></li>
<li><p>It doesn’t allow access to the list of <code class="docutils literal notranslate"><span class="pre">Data</span></code> instances itself. It exposes a <code class="docutils literal notranslate"><span class="pre">data</span></code> property which returns the list. If we decide to change the internal implementation of <code class="docutils literal notranslate"><span class="pre">DataContainer</span></code>, users of this class wouldn’t care as long as we keep the output of the <code class="docutils literal notranslate"><span class="pre">data</span></code> property similar. Even if the list is empty, it will always return something.</p></li>
</ol>
<p>Let’s see the redefined implementation of the <code class="docutils literal notranslate"><span class="pre">ProcessData</span></code> class:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ProcessData</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; Pipeline to process twin Data instances &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_container</span><span class="p">:</span> <span class="n">DataContainer</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_container</span> <span class="o">=</span> <span class="n">data_container</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">data_container</span><span class="o">.</span><span class="n">metadata</span>
        
    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Mock processing pipeline &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;sum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_container</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">means</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_container</span><span class="o">.</span><span class="n">data</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">means</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span>
</pre></div>
</div>
</div>
</div>
<p>The code snippet above is now much cleaner than the one we had beforehand. It uses the “API” of the <code class="docutils literal notranslate"><span class="pre">DataContainer</span></code> in two ways; either using a fully-featured <code class="docutils literal notranslate"><span class="pre">sum()</span></code> function, or by (securely) accessing the data using the <code class="docutils literal notranslate"><span class="pre">data</span></code> property and running non-standard processing on it (mean calculation in our case).</p>
<p>The downside is the added class - more code to write, more tests, more imports at the top. But the added value is tremendous. Think how easy it is to add new functionality into the pipeline. Everything is flexible, allowing to create a new <code class="docutils literal notranslate"><span class="pre">median()</span></code> function in the <code class="docutils literal notranslate"><span class="pre">DataContainer</span></code> class, for example. We can even change the internal structure of the <code class="docutils literal notranslate"><span class="pre">Data</span></code> class and still use the downstream class effectively.</p>
</div>
</div>
<div class="section" id="classes-as-data-types-and-class-methods">
<h3>Classes as Data Types and Class Methods<a class="headerlink" href="#classes-as-data-types-and-class-methods" title="Permalink to this headline">¶</a></h3>
<p>Yet another fairly important use case for classes in Python is their as user-defined types for particular data. Programming languages define for us the basic types of data: floating-point numbers, integres, string and so on. But what if (some of) our data is not composed of these primitive types? Can we construct data types of our own?</p>
<p>For instane, assume I’m collecting data from participants in a study I’m running, and one of the data points I’m gatheting is their age. How should I encode it?</p>
<p>The age of a person is not an integer number. It <em>can</em> be thought of as a floating point number, but then being 41.9 means that your age is 41 years and almost eleven months, which isn’t too obvious from just looking at 41.9, since the 9 could be interpreter as the month of September. We can try to write stuff like ‘41.9’ or ‘41 years and 9 months’ or ‘41.9.14’ but it doesn’t look so good.</p>
<p><strong>Instead,</strong> what we should do is to write a class that defines an age:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span>


<span class="k">class</span> <span class="nc">Grade</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represenets a single grade.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_grade</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_verify_grade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Verifies that the given grade holds up to our standards&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;too low&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;too high&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span>

    <span class="nd">@value</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_grade</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">YAERS_OUT_OF_RANGE</span> <span class="o">=</span> <span class="s2">&quot;Years should be a valid integer, received </span><span class="si">{years}</span><span class="s2">&quot;</span>
<span class="n">MONTHS_OUT_OF_RANGE</span> <span class="o">=</span> <span class="s2">&quot;Months should be an integer between 1 and 12, received </span><span class="si">{months}</span><span class="s2">&quot;</span>
<span class="n">DAYS_OUT_OF_RANGE</span> <span class="o">=</span> <span class="s2">&quot;Days should be an integer between 1 and 31, received </span><span class="si">{days}</span><span class="s2">&quot;</span>

<span class="k">class</span> <span class="nc">Age</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents the age of a person.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">years</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">months</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_input</span><span class="p">(</span><span class="n">years</span><span class="p">,</span> <span class="n">months</span><span class="p">,</span> <span class="n">days</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">years</span> <span class="o">=</span> <span class="n">years</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">months</span> <span class="o">=</span> <span class="n">months</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">days</span> <span class="o">=</span> <span class="n">days</span>
    
    <span class="k">def</span> <span class="nf">validate_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">years</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">months</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">days</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">valid_years</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">years</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">years</span> <span class="o">&lt;</span> <span class="mi">150</span>
        <span class="n">valid_months</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">months</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">months</span> <span class="o">&lt;</span> <span class="mi">13</span>
        <span class="n">valid_days</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">days</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">days</span> <span class="o">&lt;</span> <span class="mi">32</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_years</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">OUT_OF_RANGE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="n">years</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_months</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">MONTHS_OUT_OF_RANGE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="n">months</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_days</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">DAYS_OUT_OF_RANGE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">days</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>        
</pre></div>
</div>
</div>
</div>
<p>Now the DataFrame or array containing our data can have a column of type Age which will contain meaningful data about the persons age. Notice how compact this class is. It doesn’t contain the ID number of the person, nor it’s name. All it does is encode the age. It’s important that each of the class we write will have one specific purpose, and not more.</p>
<p>However, we’re not quite done here. There is another possible “representation” of age and that is the date of birth. It’s quite a natural requirement that given a date of birth, a string or a datetime object, our <code class="docutils literal notranslate"><span class="pre">Age</span></code> class will know how to generate a proper <code class="docutils literal notranslate"><span class="pre">Age</span></code> instance. Similarly, given an <code class="docutils literal notranslate"><span class="pre">Age</span></code> instance, we should be able to generate the person’s date of birth.</p>
<p>The second requirement is pretty easy, we can simply make a <code class="docutils literal notranslate"><span class="pre">get_dob()</span></code> method that returns the date of birth. But how should we approach the first requirement, of instantiating an <code class="docutils literal notranslate"><span class="pre">Age</span></code> from a given date? Let’s try to <em>refactor</em> our class:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">datetime</span>


<span class="k">class</span> <span class="nc">Age</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents the age of a person.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">cur_year</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">year</span>
    
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_str</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">date_str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Instantiate from a string containing a date in the standard ISO format. &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">date_str</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>    
            <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">cur_year</span> <span class="o">-</span> <span class="n">date</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">date</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">date</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
        
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dob</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">dob</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Instatiates from a datetime.date or a datetime.datetime object &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">years</span> <span class="o">=</span> <span class="n">dob</span><span class="o">.</span><span class="n">year</span>
            <span class="n">months</span> <span class="o">=</span> <span class="n">dob</span><span class="o">.</span><span class="n">month</span>
            <span class="n">days</span> <span class="o">=</span> <span class="n">dob</span><span class="o">.</span><span class="n">day</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input should be a datetime.datetime or a datetime.date instance. Received </span><span class="si">{</span><span class="n">dob</span><span class="si">}</span><span class="s2"> which is a </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">dob</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">years</span><span class="p">,</span> <span class="n">months</span><span class="p">,</span> <span class="n">days</span><span class="p">)</span>    
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">years</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">months</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_input</span><span class="p">(</span><span class="n">years</span><span class="p">,</span> <span class="n">months</span><span class="p">,</span> <span class="n">days</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">years</span> <span class="o">=</span> <span class="n">years</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">months</span> <span class="o">=</span> <span class="n">months</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">days</span> <span class="o">=</span> <span class="n">days</span>
        
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Age(years=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">years</span><span class="si">}</span><span class="s2">, months=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">months</span><span class="si">}</span><span class="s2">, days=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">days</span><span class="si">}</span><span class="s2">)&quot;</span>

    <span class="k">def</span> <span class="nf">validate_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">years</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">months</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">days</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">valid_years</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">years</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">years</span> <span class="o">&lt;</span> <span class="mi">150</span>
        <span class="n">valid_months</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">months</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">months</span> <span class="o">&lt;</span> <span class="mi">13</span>
        <span class="n">valid_days</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">days</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">days</span> <span class="o">&lt;</span> <span class="mi">32</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_years</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">OUT_OF_RANGE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="n">years</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_months</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">MONTHS_OUT_OF_RANGE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="n">months</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_days</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">DAYS_OUT_OF_RANGE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">days</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>       
        
    <span class="k">def</span> <span class="nf">get_dob</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the date of birth &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cur_year</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">years</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">months</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">days</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">age</span> <span class="o">=</span> <span class="n">Age</span><span class="p">(</span><span class="mi">42</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">age</span><span class="o">.</span><span class="n">get_dob</span><span class="p">()</span>
<span class="n">age2</span> <span class="o">=</span> <span class="n">Age</span><span class="o">.</span><span class="n">from_str</span><span class="p">(</span><span class="s1">&#39;2001-04-05&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">age2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Age(years=21, months=4, days=5)
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="typestates">
<h3>Typestates<a class="headerlink" href="#typestates" title="Permalink to this headline">¶</a></h3>
<p>Typestates are a way to enforce the state of our data\application with strict types.</p>
<p>Let’s assume I have 24 human volunteers in a combined fMRI + questionnaire study. I keep them all in a single DataFrame for brevity and ease-of-use, but in effect they’re in different stages of my experiment. A few were just recruited last week, and I haven’t even set a date for our first meeting. A few others were already scanned in the magnet once, but still have to go through my second questionnaire session.</p>
<p>My application monitors these students, alerts me of incoming meeting dates, and (of course) analyzes the results of the questionnaires and scans.</p>
<p>The <strong>correctness</strong> of this application can be enforced in many ways - tests, mock data, daily use - but here I choose to show another mechanism - typestates. The fact that the current status of each volunteer isn’t specified with a simple string in a table, but is actually a different class altogether, is another way to make sure that I always receive the expected output from each method call.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>


<span class="c1"># Helper types</span>
<span class="k">class</span> <span class="nc">Name</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; First and last name &quot;&quot;&quot;</span>
    <span class="c1"># Implementation omitted</span>


<span class="k">class</span> <span class="nc">Age</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; Special age type &quot;&quot;&quot;</span>
    <span class="c1"># Implementation omitted</span>


<span class="k">class</span> <span class="nc">FmriResult</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; Results from an fMRI scan &quot;&quot;&quot;</span>
    <span class="c1"># Implementation omitted</span>


<span class="c1"># Volunteer types    </span>
<span class="k">class</span> <span class="nc">Volunteer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; Base class for all volunteers in my project &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">Name</span><span class="p">,</span> <span class="n">age</span><span class="p">:</span> <span class="n">Age</span><span class="p">,</span> <span class="n">call_date</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">vol_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">age</span> <span class="o">=</span> <span class="n">age</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call_date</span> <span class="o">=</span> <span class="n">call_date</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">vol_id</span>
        
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, age </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">age</span><span class="si">}</span><span class="s2">, first called at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">call_date</span><span class="si">}</span><span class="s2">.&quot;</span>
        
    <span class="k">def</span> <span class="nf">update_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">records</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add the instance to the dataframe containing the rest of the data &quot;&quot;&quot;</span>
        <span class="n">record</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">age</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">call_date</span><span class="p">,</span> 
                               <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)])</span>
        <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">records</span>
    
    <span class="k">def</span> <span class="nf">remove_from_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">records</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Remove the instance from the student records &quot;&quot;&quot;</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">records</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>
        <span class="n">records</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">records</span>

    
<span class="k">class</span> <span class="nc">PreScanOne</span><span class="p">(</span><span class="n">Volunteer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Volunteer before the first session &quot;&quot;&quot;</span>
    <span class="n">loc</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># ordinal place in hierarchy</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">Name</span><span class="p">,</span> <span class="n">age</span><span class="p">:</span> <span class="n">Age</span><span class="p">,</span> <span class="n">call_date</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">vol_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
                 <span class="n">scan_one_date</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">call_date</span><span class="p">,</span> <span class="n">vol_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">scan_one_date</span><span class="o">=</span><span class="n">scan_one_date</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">advance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">FmriResult</span><span class="p">,</span> <span class="n">next_date</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Advance a PreScanOne to a PostScanOne &quot;&quot;&quot;</span>
        <span class="n">new</span> <span class="o">=</span> <span class="n">PostScanOne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">next_date</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new</span>
    

<span class="k">class</span> <span class="nc">PostScanOne</span><span class="p">(</span><span class="n">Volunteer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Volunteer after the first session &quot;&quot;&quot;</span>
    <span class="n">loc</span> <span class="o">=</span> <span class="mi">1</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pre_volunteer</span><span class="p">:</span> <span class="n">PreScanOne</span><span class="p">,</span> <span class="n">scan_one_data</span><span class="p">:</span> <span class="n">FmriResult</span><span class="p">,</span> 
                 <span class="n">scan_two_date</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">pre_volunteer</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pre_volunteer</span><span class="o">.</span><span class="n">age</span><span class="p">,</span> <span class="n">pre_volunteer</span><span class="o">.</span><span class="n">call_date</span><span class="p">,</span> <span class="n">pre_volunteer</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">pre_volunteer</span><span class="o">.</span><span class="n">metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;scan_one_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scan_one_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;scan_two_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scan_two_date</span>
    
    <span class="k">def</span> <span class="nf">advance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">FmriResult</span><span class="p">,</span> <span class="n">next_date</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Advance a PostScanOne to a PreScanTwo &quot;&quot;&quot;</span>
        <span class="n">new</span> <span class="o">=</span> <span class="n">PreScanTwo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">next_date</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new</span>


<span class="c1"># Examples of generic methods that use this interface</span>
<span class="k">def</span> <span class="nf">advance_volunteer</span><span class="p">(</span><span class="n">old_vol</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">FmriResult</span><span class="p">,</span> <span class="n">records</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    Move volunteer to next step in the experiment, returning the new </span>
<span class="sd">    instance and records.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">old_vol</span><span class="o">.</span><span class="n">remove_from_df</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>
    <span class="n">new_vol</span> <span class="o">=</span> <span class="n">old_vol</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">records</span><span class="p">)</span>
    <span class="n">new_vol</span><span class="o">.</span><span class="n">update_df</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_vol</span><span class="p">,</span> <span class="n">records</span>


<span class="k">def</span> <span class="nf">process_data</span><span class="p">(</span><span class="n">records</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Run the same processing function over all fMRI data &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">vol</span> <span class="ow">in</span> <span class="n">records</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vol</span><span class="o">.</span><span class="n">process_data</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>  <span class="c1"># instance doesn&#39;t have data</span>
            <span class="k">pass</span>
    <span class="k">return</span> <span class="n">results</span>
</pre></div>
</div>
</div>
</div>
<p>This is long, but interesting, so let’s try to break it down.</p>
<p>At the beginning we have a few help classes which I merely defined, but not implemented. These shouldn’t look strange to you. We talked during class of how an <code class="docutils literal notranslate"><span class="pre">Age</span></code> type is an important example of defining our own types in a program, since it’s neither an integer nor a floating point number.</p>
<p>The second part is the most interesting. We have a base class called <code class="docutils literal notranslate"><span class="pre">Volunteer</span></code> which contains basic information which is common to all experiment volunteers. But it’s actually more than that - it also defines the <em>interfaces</em> between the classes, it forces the classes to have specific attributes that will comply to this protocol, linking their behavior together.</p>
<p>The other two classes inherit from <code class="docutils literal notranslate"><span class="pre">Volunteer</span></code> and represent the first two steps in the “Volunteer path”. The <code class="docutils literal notranslate"><span class="pre">loc</span></code> class variable signifies that. From phase one (<code class="docutils literal notranslate"><span class="pre">PreScanOne</span></code>( a volunteer can only advance forward (or drop out from the experiment) to step 2. And likewise from step 2 to 3 - you’ll always find the same <code class="docutils literal notranslate"><span class="pre">.advance()</span></code> method that takes you to the next step, even though the implementation is slightly different. To handle the variability in the held data, we have the <code class="docutils literal notranslate"><span class="pre">metadata</span></code> attribute which can hold different parameters and datapoints.</p>
<p>The last part shows how to use such an interface. We have a function that advances an instance of a class “one step” to the next phase. We have a function that runs some processing on the data held inside the instances, and we can have as many functions (and classes as we wish). It’s completely extensible since the API is well-defined.</p>
</div>
</div>
<div class="section" id="helper-concepts-and-libraries">
<h2>Helper Concepts and Libraries<a class="headerlink" href="#helper-concepts-and-libraries" title="Permalink to this headline">¶</a></h2>
<p>In practice, good and clear software design can be aided from using unique Python features and packages. We’ll review a few of the more prominent ones:</p>
<div class="section" id="code-formatting-styling-and-linting">
<h3>Code formatting, styling and linting<a class="headerlink" href="#code-formatting-styling-and-linting" title="Permalink to this headline">¶</a></h3>
<p>As you remember, from day one I insisted that your code should have a very specific look, as defined in PEP8, the official document describing how to style your Python. Happily enough there are a few tools that can automate this work for us, and the most famous one is <code class="docutils literal notranslate"><span class="pre">black</span></code>, which can be operated from either the command line or directly from VSCode. I’ll show how to do it in after we review a few other libraries of the same type right below.</p>
</div>
<div class="section" id="type-annotations-and-mypy">
<h3>Type Annotations and MyPy<a class="headerlink" href="#type-annotations-and-mypy" title="Permalink to this headline">¶</a></h3>
<p>Since version 3.6, Python allows this syntax:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Dict</span>

<span class="k">def</span> <span class="nf">doer_of_stuffs</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;ccc&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Does stuff to a, b, and c.</span>
<span class="sd">    Returns: A tuple of a string and a dictionary mapping ints to floats</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a_helper</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">b_helper</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">b</span> <span class="o">/</span> <span class="mi">3</span>
    <span class="n">int_a</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">a_helper</span><span class="p">)</span>
    <span class="n">c2</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">c</span> <span class="o">+</span> <span class="n">c</span>
    <span class="k">return</span> <span class="n">c2</span><span class="p">,</span> <span class="p">{</span><span class="n">b</span><span class="p">:</span> <span class="n">a_helper</span><span class="p">,</span> <span class="n">int_a</span><span class="p">:</span> <span class="n">b_helper</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>While a bit more verbose, these <em>type annotations</em> make things clearer when dealing with large codebases. Knowing the defined type of your variables as they bounce around between modules and functions can help with the debugging process of your code tremendously.</p>
<p>Moreover, modern IDEs like PyCharm and VSCode will alert you before you run the code of any possible type errors. For example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># integer</span>
    <span class="n">a</span> <span class="o">/=</span> <span class="mi">2</span>  <span class="c1"># now it&#39;s a float</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    
    <span class="c1"># ... lots of code here</span>
    
    <span class="n">b</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>  <span class="c1"># TypeError - cannot index with a float variable</span>
</pre></div>
</div>
</div>
</div>
<p>VSCode will mark this <code class="docutils literal notranslate"><span class="pre">arr[a]</span></code> expression and try to prevent you from running this code.</p>
<p>A more wholesome approach is <a class="reference external" href="https://github.com/python/mypy"><code class="docutils literal notranslate"><span class="pre">mypy</span></code></a>, which was developed in Dropbox, a company very reliant on its Python-based product. When the Dropbox codebase increased in size, its engineers wanted to keep using Python due to its amazing features, but avoid the problems that come with a dynamically-typed language. Thus, <code class="docutils literal notranslate"><span class="pre">mypy</span></code> was born. In essence, it’s a command-line tool that runs type checks on the entirety of your code base, verifying the type-correctness of your application. In many places a clean <code class="docutils literal notranslate"><span class="pre">mypy</span></code> error log is required before committing changes to the code base.</p>
<p><code class="docutils literal notranslate"><span class="pre">mypy</span></code> supports both comment-based type annotations for older versions of Python (Dropbox used Python 2.7 until 2019) and the new style of type annotations shown above. It can also generate type annotations on the fly, using <code class="docutils literal notranslate"><span class="pre">PyAnnotate</span></code>, while you run your application.</p>
</div>
<div class="section" id="linters-pylint-flake8">
<h3>Linters (<code class="docutils literal notranslate"><span class="pre">pylint</span></code>, <code class="docutils literal notranslate"><span class="pre">flake8</span></code>)<a class="headerlink" href="#linters-pylint-flake8" title="Permalink to this headline">¶</a></h3>
<p>The last tools we’ll dicuss are linters, which check the correctness of your code in several key aspects. First, they point out violations of simple PEP8 rules, like wrong variable naming and such. But more importantly they’ll make sure that your code is in a runnable state, which means that you’re not using variables you haven’t declared, or libraries which you haven’t imported, and such. Just like <code class="docutils literal notranslate"><span class="pre">black</span></code> and <code class="docutils literal notranslate"><span class="pre">mypy</span></code>, these two tools can also be configured to work with VSCode.</p>
</div>
<div class="section" id="enumerations">
<h3>Enumerations<a class="headerlink" href="#enumerations" title="Permalink to this headline">¶</a></h3>
<p>Python added enumeration support in Python 3.4, and it’s starting to pop-up more and more in new code bases. An enumeration is a list of discrete possible values. Assuming I have a simple addition function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">add_or_sub</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Simple addition\subtraction &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="k">if</span> <span class="n">add</span> <span class="k">else</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span>
</pre></div>
</div>
</div>
</div>
<p>The list of possible values for <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code> is endless, so these cannot be enumerated. The <code class="docutils literal notranslate"><span class="pre">add</span></code> keyword is called a “flag”, since it has two possible values - <code class="docutils literal notranslate"><span class="pre">True</span></code> and <code class="docutils literal notranslate"><span class="pre">False</span></code>. It’s an enumeration of two possible values.</p>
<p>When we have more than two options, or when our two options aren’t simply booleans, we can use an enumeration. Here’s a simple example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>


<span class="k">class</span> <span class="nc">Color</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">RED</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span>
    <span class="n">GREEN</span> <span class="o">=</span> <span class="s1">&#39;g&#39;</span>
    <span class="n">BLUE</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span>
    <span class="n">BLACK</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span>
</pre></div>
</div>
</div>
</div>
<p>Each of the <code class="docutils literal notranslate"><span class="pre">Enum</span></code>’s attributes now has a <code class="docutils literal notranslate"><span class="pre">name</span></code> and a <code class="docutils literal notranslate"><span class="pre">value</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">Color</span><span class="o">.</span><span class="n">RED</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">Color</span><span class="o">.</span><span class="n">RED</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>RED
r
</pre></div>
</div>
</div>
</div>
<p>In the “real world” enumerations aren’t too popular due to the fact that they were introduced very late. But a use-case could look like the following:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>


<span class="n">rng</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;1/1/2018&#39;</span><span class="p">,</span><span class="n">periods</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>  <span class="c1"># &#39;D&#39; is days</span>
<span class="n">rng</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DatetimeIndex([&#39;2018-01-01&#39;, &#39;2018-01-02&#39;, &#39;2018-01-03&#39;, &#39;2018-01-04&#39;,
               &#39;2018-01-05&#39;, &#39;2018-01-06&#39;, &#39;2018-01-07&#39;, &#39;2018-01-08&#39;,
               &#39;2018-01-09&#39;, &#39;2018-01-10&#39;, &#39;2018-01-11&#39;, &#39;2018-01-12&#39;,
               &#39;2018-01-13&#39;, &#39;2018-01-14&#39;, &#39;2018-01-15&#39;, &#39;2018-01-16&#39;,
               &#39;2018-01-17&#39;, &#39;2018-01-18&#39;, &#39;2018-01-19&#39;, &#39;2018-01-20&#39;,
               &#39;2018-01-21&#39;, &#39;2018-01-22&#39;, &#39;2018-01-23&#39;, &#39;2018-01-24&#39;,
               &#39;2018-01-25&#39;, &#39;2018-01-26&#39;, &#39;2018-01-27&#39;, &#39;2018-01-28&#39;,
               &#39;2018-01-29&#39;, &#39;2018-01-30&#39;, &#39;2018-01-31&#39;, &#39;2018-02-01&#39;,
               &#39;2018-02-02&#39;, &#39;2018-02-03&#39;, &#39;2018-02-04&#39;, &#39;2018-02-05&#39;,
               &#39;2018-02-06&#39;, &#39;2018-02-07&#39;, &#39;2018-02-08&#39;, &#39;2018-02-09&#39;,
               &#39;2018-02-10&#39;, &#39;2018-02-11&#39;, &#39;2018-02-12&#39;, &#39;2018-02-13&#39;,
               &#39;2018-02-14&#39;, &#39;2018-02-15&#39;, &#39;2018-02-16&#39;, &#39;2018-02-17&#39;,
               &#39;2018-02-18&#39;, &#39;2018-02-19&#39;, &#39;2018-02-20&#39;, &#39;2018-02-21&#39;,
               &#39;2018-02-22&#39;, &#39;2018-02-23&#39;, &#39;2018-02-24&#39;, &#39;2018-02-25&#39;,
               &#39;2018-02-26&#39;, &#39;2018-02-27&#39;, &#39;2018-02-28&#39;, &#39;2018-03-01&#39;,
               &#39;2018-03-02&#39;, &#39;2018-03-03&#39;, &#39;2018-03-04&#39;, &#39;2018-03-05&#39;,
               &#39;2018-03-06&#39;, &#39;2018-03-07&#39;, &#39;2018-03-08&#39;, &#39;2018-03-09&#39;,
               &#39;2018-03-10&#39;, &#39;2018-03-11&#39;, &#39;2018-03-12&#39;, &#39;2018-03-13&#39;,
               &#39;2018-03-14&#39;, &#39;2018-03-15&#39;, &#39;2018-03-16&#39;, &#39;2018-03-17&#39;,
               &#39;2018-03-18&#39;, &#39;2018-03-19&#39;, &#39;2018-03-20&#39;, &#39;2018-03-21&#39;,
               &#39;2018-03-22&#39;, &#39;2018-03-23&#39;, &#39;2018-03-24&#39;, &#39;2018-03-25&#39;,
               &#39;2018-03-26&#39;, &#39;2018-03-27&#39;, &#39;2018-03-28&#39;, &#39;2018-03-29&#39;,
               &#39;2018-03-30&#39;, &#39;2018-03-31&#39;, &#39;2018-04-01&#39;, &#39;2018-04-02&#39;,
               &#39;2018-04-03&#39;, &#39;2018-04-04&#39;, &#39;2018-04-05&#39;, &#39;2018-04-06&#39;,
               &#39;2018-04-07&#39;, &#39;2018-04-08&#39;, &#39;2018-04-09&#39;, &#39;2018-04-10&#39;],
              dtype=&#39;datetime64[ns]&#39;, freq=&#39;D&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rng</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;1/1/2018&#39;</span><span class="p">,</span><span class="n">periods</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">)</span>  <span class="c1"># it can also be &#39;M&#39;</span>
<span class="n">rng</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DatetimeIndex([&#39;2018-01-31&#39;, &#39;2018-02-28&#39;, &#39;2018-03-31&#39;, &#39;2018-04-30&#39;,
               &#39;2018-05-31&#39;, &#39;2018-06-30&#39;, &#39;2018-07-31&#39;, &#39;2018-08-31&#39;,
               &#39;2018-09-30&#39;, &#39;2018-10-31&#39;, &#39;2018-11-30&#39;, &#39;2018-12-31&#39;,
               &#39;2019-01-31&#39;, &#39;2019-02-28&#39;, &#39;2019-03-31&#39;, &#39;2019-04-30&#39;,
               &#39;2019-05-31&#39;, &#39;2019-06-30&#39;, &#39;2019-07-31&#39;, &#39;2019-08-31&#39;,
               &#39;2019-09-30&#39;, &#39;2019-10-31&#39;, &#39;2019-11-30&#39;, &#39;2019-12-31&#39;,
               &#39;2020-01-31&#39;, &#39;2020-02-29&#39;, &#39;2020-03-31&#39;, &#39;2020-04-30&#39;,
               &#39;2020-05-31&#39;, &#39;2020-06-30&#39;, &#39;2020-07-31&#39;, &#39;2020-08-31&#39;,
               &#39;2020-09-30&#39;, &#39;2020-10-31&#39;, &#39;2020-11-30&#39;, &#39;2020-12-31&#39;,
               &#39;2021-01-31&#39;, &#39;2021-02-28&#39;, &#39;2021-03-31&#39;, &#39;2021-04-30&#39;,
               &#39;2021-05-31&#39;, &#39;2021-06-30&#39;, &#39;2021-07-31&#39;, &#39;2021-08-31&#39;,
               &#39;2021-09-30&#39;, &#39;2021-10-31&#39;, &#39;2021-11-30&#39;, &#39;2021-12-31&#39;,
               &#39;2022-01-31&#39;, &#39;2022-02-28&#39;, &#39;2022-03-31&#39;, &#39;2022-04-30&#39;,
               &#39;2022-05-31&#39;, &#39;2022-06-30&#39;, &#39;2022-07-31&#39;, &#39;2022-08-31&#39;,
               &#39;2022-09-30&#39;, &#39;2022-10-31&#39;, &#39;2022-11-30&#39;, &#39;2022-12-31&#39;,
               &#39;2023-01-31&#39;, &#39;2023-02-28&#39;, &#39;2023-03-31&#39;, &#39;2023-04-30&#39;,
               &#39;2023-05-31&#39;, &#39;2023-06-30&#39;, &#39;2023-07-31&#39;, &#39;2023-08-31&#39;,
               &#39;2023-09-30&#39;, &#39;2023-10-31&#39;, &#39;2023-11-30&#39;, &#39;2023-12-31&#39;,
               &#39;2024-01-31&#39;, &#39;2024-02-29&#39;, &#39;2024-03-31&#39;, &#39;2024-04-30&#39;,
               &#39;2024-05-31&#39;, &#39;2024-06-30&#39;, &#39;2024-07-31&#39;, &#39;2024-08-31&#39;,
               &#39;2024-09-30&#39;, &#39;2024-10-31&#39;, &#39;2024-11-30&#39;, &#39;2024-12-31&#39;,
               &#39;2025-01-31&#39;, &#39;2025-02-28&#39;, &#39;2025-03-31&#39;, &#39;2025-04-30&#39;,
               &#39;2025-05-31&#39;, &#39;2025-06-30&#39;, &#39;2025-07-31&#39;, &#39;2025-08-31&#39;,
               &#39;2025-09-30&#39;, &#39;2025-10-31&#39;, &#39;2025-11-30&#39;, &#39;2025-12-31&#39;,
               &#39;2026-01-31&#39;, &#39;2026-02-28&#39;, &#39;2026-03-31&#39;, &#39;2026-04-30&#39;],
              dtype=&#39;datetime64[ns]&#39;, freq=&#39;M&#39;)
</pre></div>
</div>
</div>
</div>
<p>What are the possible values for the <code class="docutils literal notranslate"><span class="pre">freq</span></code> keyword? Day is <code class="docutils literal notranslate"><span class="pre">D</span></code>, month is <code class="docutils literal notranslate"><span class="pre">M</span></code>, Year will probably be <code class="docutils literal notranslate"><span class="pre">Y</span></code>. Are there any more keywords? Will <code class="docutils literal notranslate"><span class="pre">d</span></code> also work, or do I have to use capital <code class="docutils literal notranslate"><span class="pre">D</span></code>? Actually, checking the <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/generated/pandas.date_range.html">official</a> documentation doesn’t result in anything too useful.</p>
<p>This is where enumerations come into play. This could’ve been simpler if we could only choose a value from a list of possible values:</p>
<div class="cell tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DateRangeFreq</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">D</span> <span class="o">=</span> <span class="s1">&#39;days&#39;</span>
    <span class="n">M</span> <span class="o">=</span> <span class="s1">&#39;months&#39;</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="s1">&#39;years&#39;</span>

<span class="n">rng</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;1/1/2018&#39;</span><span class="p">,</span><span class="n">periods</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DateRangeFreq</span><span class="o">.</span><span class="n">D</span><span class="p">)</span>  <span class="c1"># doesn&#39;t actually work...</span>
</pre></div>
</div>
</div>
</div>
<p>If we were unsure of the available parameters, we could import the <code class="docutils literal notranslate"><span class="pre">DateRangeFreq</span></code> object and inspect its possible values. As you can see, each key has a value associated with it. This value can be an integer, string or even a Python object.</p>
<p>Enumerations are gaining popularity in the Python ecosystem and are a simple thing that’s great to implement and increase the robustness of your codebase.</p>
</div>
<div class="section" id="attrs-classes-without-boilerplate">
<h3><code class="docutils literal notranslate"><span class="pre">attrs</span></code> - Classes without boilerplate<a class="headerlink" href="#attrs-classes-without-boilerplate" title="Permalink to this headline">¶</a></h3>
<p>Python classes are extremely useful, but they’re also pretty verbose. They require you to write a lot of code for very basic operations.</p>
<p>For example, in the the <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> method you have to go through each variable in the function signature and assign it to your own value:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Example</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param1</span><span class="p">,</span> <span class="n">param2</span><span class="p">,</span> <span class="n">param3</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">,</span> <span class="n">param4</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param1</span> <span class="o">=</span> <span class="n">param1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param2</span> <span class="o">=</span> <span class="n">param2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param3</span> <span class="o">=</span> <span class="n">param3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param4</span> <span class="o">=</span> <span class="n">param4</span>
    
    <span class="k">def</span> <span class="nf">my_method</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Do stuff &quot;&quot;&quot;</span>
        <span class="k">pass</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span>  <span class="n">Input</span> <span class="n">In</span> <span class="p">[</span><span class="mi">89</span><span class="p">]</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param1</span><span class="p">,</span> <span class="n">param2</span><span class="p">,</span> <span class="n">param3</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">,</span> <span class="n">param4</span><span class="p">):</span>
                 <span class="o">^</span>
<span class="ne">SyntaxError</span>: non-default argument follows default argument
</pre></div>
</div>
</div>
</div>
<p>So many lines of repetitive code doing basically nothing. I didn’t assert the types of the variables, I didn’t do some basic pre-processing - this is called “boilerplate” code. Python requires me to write these tedious lines every time I create a class, and when classes get bigger and bigger, these assignments can be a hassle to write.</p>
<p><code class="docutils literal notranslate"><span class="pre">attrs</span></code> to the rescue:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">attr</span>
<span class="kn">from</span> <span class="nn">attr.validators</span> <span class="kn">import</span> <span class="n">instance_of</span>


<span class="nd">@attr</span><span class="o">.</span><span class="n">s</span>
<span class="k">class</span> <span class="nc">ExampleTwo</span><span class="p">:</span>
    <span class="n">param1</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span><span class="n">validator</span><span class="o">=</span><span class="n">instance_of</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
    <span class="n">param2</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span><span class="n">validator</span><span class="o">=</span><span class="n">instance_of</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span>
    <span class="n">param3</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;no&#39;</span><span class="p">)</span>
    <span class="n">param4</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">attr</span><span class="o">.</span><span class="n">Factory</span><span class="p">(</span><span class="nb">list</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">my_method</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Do stuff &quot;&quot;&quot;</span>
        <span class="k">pass</span>


<span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ExampleThree</span><span class="p">:</span>
    <span class="n">param1</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">param2</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">param3</span> <span class="o">=</span> <span class="s1">&#39;no&#39;</span>
    <span class="n">param4</span> <span class="o">=</span> <span class="p">[]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="n">ExampleTwo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
<span class="n">a</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ExampleTwo(param1=1, param2=2.0, param3=&#39;a&#39;, param4=[4, 5, 6])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b</span> <span class="o">=</span> <span class="n">ExampleTwo</span><span class="p">(</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="nn">Input In [92],</span> in <span class="ni">&lt;cell line: 1&gt;</span><span class="nt">()</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">b</span> <span class="o">=</span> <span class="n">ExampleTwo</span><span class="p">(</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>

<span class="nn">File &lt;attrs generated init __main__.ExampleTwo&gt;:10,</span> in <span class="ni">__init__</span><span class="nt">(self, param1, param2, param3, param4)</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span>     <span class="bp">self</span><span class="o">.</span><span class="n">param4</span> <span class="o">=</span> <span class="n">__attr_factory_param4</span><span class="p">()</span>
<span class="g g-Whitespace">      </span><span class="mi">9</span> <span class="k">if</span> <span class="n">_config</span><span class="o">.</span><span class="n">_run_validators</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">10</span>     <span class="n">__attr_validator_param1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">__attr_param1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">param1</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">11</span>     <span class="n">__attr_validator_param2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">__attr_param2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">param2</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/site-packages/attr/validators.py:103,</span> in <span class="ni">_InstanceOfValidator.__call__</span><span class="nt">(self, inst, attr, value)</span>
<span class="g g-Whitespace">     </span><span class="mi">99</span> <span class="sd">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">100</span><span class="sd"> We use a callable class to be able to change the ``__repr__``.</span>
<span class="g g-Whitespace">    </span><span class="mi">101</span><span class="sd"> &quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">102</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">103</span>     <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">104</span>         <span class="s2">&quot;&#39;</span><span class="si">{name}</span><span class="s2">&#39; must be </span><span class="si">{type!r}</span><span class="s2"> (got </span><span class="si">{value!r}</span><span class="s2"> that is a &quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">105</span>         <span class="s2">&quot;</span><span class="si">{actual!r}</span><span class="s2">).&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">106</span>             <span class="n">name</span><span class="o">=</span><span class="n">attr</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">107</span>             <span class="nb">type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">108</span>             <span class="n">actual</span><span class="o">=</span><span class="n">value</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">109</span>             <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">110</span>         <span class="p">),</span>
<span class="g g-Whitespace">    </span><span class="mi">111</span>         <span class="n">attr</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">112</span>         <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">113</span>         <span class="n">value</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">114</span>     <span class="p">)</span>

<span class="ne">TypeError</span>: (&quot;&#39;param1&#39; must be &lt;class &#39;int&#39;&gt; (got 1.1 that is a &lt;class &#39;float&#39;&gt;).&quot;, Attribute(name=&#39;param1&#39;, default=NOTHING, validator=&lt;instance_of validator for type &lt;class &#39;int&#39;&gt;&gt;, repr=True, eq=True, eq_key=None, order=True, order_key=None, hash=None, init=True, metadata=mappingproxy({}), type=None, converter=None, kw_only=False, inherited=False, on_setattr=None), &lt;class &#39;int&#39;&gt;, 1.1)
</pre></div>
</div>
</div>
</div>
<p>That’s it. No <code class="docutils literal notranslate"><span class="pre">__init__</span></code> is required, each <code class="docutils literal notranslate"><span class="pre">paramX</span></code> variable is already assigned to <code class="docutils literal notranslate"><span class="pre">self.paramX</span></code>. It also allows the addition of validators, default values, converter functions (not shown), and it even implements the comparison methods (<code class="docutils literal notranslate"><span class="pre">__eq__</span></code>, <code class="docutils literal notranslate"><span class="pre">__gt__</span></code>, etc.) for you. It has a ton of other useful features which I won’t go into right now, but you can be sure that it’s a package worth using.</p>
</div>
<div class="section" id="dimensionality-analysis-and-units">
<h3>Dimensionality analysis and units<a class="headerlink" href="#dimensionality-analysis-and-units" title="Permalink to this headline">¶</a></h3>
<p>When working with numbers that have units, it’s usually a good idea to keep the physical quantity assigned to that value as close as possible.</p>
<p>When you’re measuring the local field potential using some electrode array, it’s good practice to verify that throughout the entirety of your processing pipeline, the voltage values aren’t divided by a number with units of time, because units of <em>[Volts] / [seconds]</em> usually have no physical meaning. It can also help you assert that your dF/F calculation indeed has natural units, and not some other arbitrary units.</p>
<p>There are many options in the Python world for dimensionality analysis. If you’re using Python to write symbolic math and solve equations, I suggest you use SymPy’s <code class="docutils literal notranslate"><span class="pre">physics.units</span></code> module. Else - use <code class="docutils literal notranslate"><span class="pre">pint</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pint</span>


<span class="n">ureg</span> <span class="o">=</span> <span class="n">pint</span><span class="o">.</span><span class="n">UnitRegistry</span><span class="p">()</span>
<span class="mi">3</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">cm</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">3.04 meter</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">measures</span> <span class="o">=</span> <span class="n">ureg</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="s1">&#39;volts&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">measures</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0.7007967702978262 0.19741232596574187 0.07524094418909011 0.3561537582421409 0.18432190323869635 0.3645915590129989 0.4111980708923684 0.4388513464596915 0.7005974785662764 0.04303213857737809] volt
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">measures</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1.4015935405956523 0.39482465193148375 0.15048188837818022 0.7123075164842818 0.3686438064773927 0.7291831180259978 0.8223961417847367 0.877702692919383 1.4011949571325528 0.08606427715475617] volt
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">amps</span> <span class="o">=</span> <span class="n">measures</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">ohm</span><span class="p">)</span>  <span class="c1"># I = V/R</span>
<span class="n">amps</span><span class="o">.</span><span class="n">dimensionality</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;UnitsContainer({&#39;[current]&#39;: 1})&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">amps</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;seconds&#39;</span><span class="p">)</span>  <span class="c1"># DimensionalityError</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">DimensionalityError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="nn">Input In [97],</span> in <span class="ni">&lt;cell line: 1&gt;</span><span class="nt">()</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">amps</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;seconds&#39;</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/site-packages/pint/quantity.py:716,</span> in <span class="ni">Quantity.to</span><span class="nt">(self, other, *contexts, **ctx_kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">699</span> <span class="sd">&quot;&quot;&quot;Return Quantity rescaled to different units.</span>
<span class="g g-Whitespace">    </span><span class="mi">700</span><span class="sd"> </span>
<span class="g g-Whitespace">    </span><span class="mi">701</span><span class="sd"> Parameters</span>
<span class="sd">   (...)</span>
<span class="g g-Whitespace">    </span><span class="mi">712</span><span class="sd"> pint.Quantity</span>
<span class="g g-Whitespace">    </span><span class="mi">713</span><span class="sd"> &quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">714</span> <span class="n">other</span> <span class="o">=</span> <span class="n">to_units_container</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_REGISTRY</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">716</span> <span class="n">magnitude</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_magnitude_not_inplace</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="o">*</span><span class="n">contexts</span><span class="p">,</span> <span class="o">**</span><span class="n">ctx_kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">718</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">magnitude</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/site-packages/pint/quantity.py:665,</span> in <span class="ni">Quantity._convert_magnitude_not_inplace</span><span class="nt">(self, other, *contexts, **ctx_kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">662</span>     <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_REGISTRY</span><span class="o">.</span><span class="n">context</span><span class="p">(</span><span class="o">*</span><span class="n">contexts</span><span class="p">,</span> <span class="o">**</span><span class="n">ctx_kwargs</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">663</span>         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_REGISTRY</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_magnitude</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_units</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">665</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_REGISTRY</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_magnitude</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_units</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/site-packages/pint/registry.py:1044,</span> in <span class="ni">BaseRegistry.convert</span><span class="nt">(self, value, src, dst, inplace)</span>
<span class="g g-Whitespace">   </span><span class="mi">1041</span> <span class="k">if</span> <span class="n">src</span> <span class="o">==</span> <span class="n">dst</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1042</span>     <span class="k">return</span> <span class="n">value</span>
<span class="ne">-&gt; </span><span class="mi">1044</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">inplace</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/site-packages/pint/registry.py:1959,</span> in <span class="ni">ContextRegistry._convert</span><span class="nt">(self, value, src, dst, inplace)</span>
<span class="g g-Whitespace">   </span><span class="mi">1955</span>             <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_ctx</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1957</span>         <span class="n">value</span><span class="p">,</span> <span class="n">src</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">_magnitude</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">_units</span>
<span class="ne">-&gt; </span><span class="mi">1959</span> <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_convert</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">inplace</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/site-packages/pint/registry.py:1566,</span> in <span class="ni">NonMultiplicativeRegistry._convert</span><span class="nt">(self, value, src, dst, inplace)</span>
<span class="g g-Whitespace">   </span><span class="mi">1561</span>     <span class="k">raise</span> <span class="n">DimensionalityError</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1562</span>         <span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">extra_msg</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot; - In destination units, </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="g g-Whitespace">   </span><span class="mi">1563</span>     <span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1565</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">src_offset_unit</span> <span class="ow">or</span> <span class="n">dst_offset_unit</span><span class="p">):</span>
<span class="ne">-&gt; </span><span class="mi">1566</span>     <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_convert</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">inplace</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1568</span> <span class="n">src_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dimensionality</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1569</span> <span class="n">dst_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dimensionality</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.8.12/x64/lib/python3.8/site-packages/pint/registry.py:1077,</span> in <span class="ni">BaseRegistry._convert</span><span class="nt">(self, value, src, dst, inplace, check_dimensionality)</span>
<span class="g g-Whitespace">   </span><span class="mi">1074</span>     <span class="c1"># If the source and destination dimensionality are different,</span>
<span class="g g-Whitespace">   </span><span class="mi">1075</span>     <span class="c1"># then the conversion cannot be performed.</span>
<span class="g g-Whitespace">   </span><span class="mi">1076</span>     <span class="k">if</span> <span class="n">src_dim</span> <span class="o">!=</span> <span class="n">dst_dim</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1077</span>         <span class="k">raise</span> <span class="n">DimensionalityError</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">src_dim</span><span class="p">,</span> <span class="n">dst_dim</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1079</span> <span class="c1"># Here src and dst have only multiplicative units left. Thus we can</span>
<span class="g g-Whitespace">   </span><span class="mi">1080</span> <span class="c1"># convert with a factor.</span>
<span class="g g-Whitespace">   </span><span class="mi">1081</span> <span class="n">factor</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_root_units</span><span class="p">(</span><span class="n">src</span> <span class="o">/</span> <span class="n">dst</span><span class="p">)</span>

<span class="ne">DimensionalityError</span>: Cannot convert from &#39;volt / ohm&#39; ([current]) to &#39;second&#39; ([time])
</pre></div>
</div>
</div>
</div>
<p>For some projects this can be a pretty big overkill, but for others this can save many “silent” bugs.</p>
</div>
</div>
<div class="section" id="design-vs-productivity">
<h2>Design vs. Productivity<a class="headerlink" href="#design-vs-productivity" title="Permalink to this headline">¶</a></h2>
<p>Before we start exercising, one important note to remember: There’s a thin line between under- and over-engineering. Very small scripting projects require almost no engineering at all. This might mean that after you gain a few extra months of experience in Python, the structure of code for a small scripting job in Python might be obvious for you right from the get-go. You’ll know which data structures you’ll have, whether or not you’ll need a class or two, and how the user interface might go.</p>
<p>On the other hand, large applications which span at least a few thousands lines of code will always need <em>some</em> form of pre-planning. It would be senseless not to write out a diagram of the main modules in your code and their interfaces. One can consider this to be common knowledge, or a simple programmer’s instinct. Just like architects sit down and plan for months in advance the construct what they’re about to create, programmers should spell out the architecture of their own programs. In no way will this guarantee you’ll get the architecture right in the first time, but the design might serve as good building blocks when you start the refactoring process.</p>
<p>Problems mostly occur when you write medium-sized scripts, up to a couple thousand lines. These scripts usually start out small - a few functions that deal with file I/O and display of data - but can grow quite quickly once you start adding functionality. When the script was short you probably didn’t even write tests, since you were sure you’re handling some insignificant piece of code, and now it starts biting back at you.</p>
<p>It’s hard to write rules for these occasions. When someone asks me for improved functionality on some short script I wrote, I sometimes tell them it will take more time than I think it should, since I want to devote time to refactor the code, add tests and make the new functionality feel more natural inside it.</p>
<p>It’s also good practice to use classes to bind data and methods, even when you think they might be an overkill. It’s much easier to expand the functionality of classes than of an assortment of functions.</p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./classes/class_9"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="../class_8/class_8.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Class 8: Testing and Test-Driven Development</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="../class_10/class_10.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Class 10: Introduction to Machine Learning</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By Dr. Hagai Hargil, Zvi Baratz, Gal Ben-Zvi<br/>
    
        &copy; Copyright 2021.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>